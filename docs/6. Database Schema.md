# **6\. Database Schema**

### **6.1 Firestore Collections Structure**

#### **Collection: bookings**

interface Booking {  
  id: string;                    // Auto-generated document ID  
    
  // Customer Information  
  customer: {  
    name: string;                // "คุณสมชาย ใจดี"  
    phone: string;               // "081-234-5678"  
    email: string;               // "somchai@email.com"  
    address: string;             // Full address  
    tags: string\[\];              // \["VIP", "Regular"\]  
    preferredStaffId?: string;   // (NEW) For repeat customers  
  };  
    
  // Service Details  
  service: {  
    type: 'cleaning' | 'training';  
    category: 'deep' | 'regular' | 'individual' | 'corporate';  
    name: string;                // "Deep Cleaning"  
    requiredSkills: string\[\];    // (NEW) \["Deep Cleaning", "Condo"\]  
    estimatedDuration: number;   // minutes  
  };  
    
  // Scheduling  
  schedule: {  
    date: string;                // ISO date: "2025-10-15"  
    time: string;                // "10:00"  
    endTime: string;             // (NEW) "14:00" (calculated)  
    duration: number;            // minutes: 240  
    timezone: string;            // "Asia/Bangkok"  
  };  
    
  // Assignment (UPDATED)  
  assignedTo?: {  
    id: string;                  // Staff member ID  
    name: string;                // Staff member name  
    photoURL?: string;           // (NEW)  
    assignedAt: Timestamp;  
    assignedBy: string;          // Admin user ID  
    acceptedAt?: Timestamp;      // (NEW) When staff confirmed  
    status: 'pending' | 'accepted' | 'declined'; // (NEW)  
  };  
    
  // Team Assignment (NEW \- for multi-person jobs)  
  team?: Array\<{  
    staffId: string;  
    role: 'lead' | 'member';  
    assignedAt: Timestamp;  
  }\>;  
    
  // Status & Workflow  
  status: 'pending' | 'confirmed' | 'in\_progress' | 'completed' | 'cancelled';  
  statusHistory: Array\<{  
    status: string;  
    changedAt: Timestamp;  
    changedBy: string;           // User ID or Staff ID  
    reason?: string;             // For cancellations  
  }\>;  
    
  // Completion Details (NEW)  
  completion?: {  
    completedAt: Timestamp;  
    completedBy: string;         // Staff ID  
    actualDuration: number;      // minutes  
    notes: string;               // Staff notes  
    customerSignature?: string;  // Base64 or URL  
  };  
    
  // Additional Information  
  notes: string;                 // Admin notes  
  customerNotes?: string;        // Customer special requests  
  internalNotes?: string;        // Private team notes  
    
  // Recurring (for future)  
  isRecurring: boolean;  
  recurringPattern?: {  
    frequency: 'weekly' | 'biweekly' | 'monthly';  
    parentBookingId?: string;  
  };  
    
  // Metadata  
  createdAt: Timestamp;  
  createdBy: string;             // User ID  
  updatedAt: Timestamp;  
  updatedBy: string;  
    
  // Pricing  
  pricing?: {  
    basePrice: number;  
    addOns: Array\<{  
      name: string;  
      price: number;  
    }\>;  
    total: number;  
    currency: 'THB';  
  };  
    
  // Location (NEW \- for route optimization)  
  location?: {  
    lat: number;  
    lng: number;  
    address: string;  
  };  
}

#### **Collection: staff (NEW)**

interface StaffMember {  
  id: string;  
    
  // Personal Information  
  personalInfo: {  
    firstName: string;  
    lastName: string;  
    nickname?: string;           // Display name  
    photoURL?: string;           // Profile photo  
    dateOfBirth: string;         // ISO date  
    nationalId: string;          // Encrypted  
    phone: string;  
    email?: string;  
    lineId?: string;  
    address: string;  
  };  
    
  // Emergency Contact  
  emergencyContact: {  
    name: string;  
    relationship: string;  
    phone: string;  
  };  
    
  // Employment Details  
  employment: {  
    employeeId: string;          // Company employee ID  
    role: 'cleaner' | 'trainer' | 'team\_lead' | 'supervisor';  
    employmentType: 'full\_time' | 'part\_time' | 'contract' | 'freelance';  
    startDate: string;           // ISO date  
    endDate?: string;            // For contracts  
    department: string;          // "Cleaning" or "Training"  
  };  
    
  // Skills & Certifications  
  skills: {  
    primary: string\[\];           // \["Deep Cleaning", "Regular Maintenance"\]  
    secondary: string\[\];         // \["Window Cleaning", "Carpet Care"\]  
    certifications: Array\<{  
      name: string;  
      issuer: string;  
      issuedDate: string;  
      expiryDate?: string;  
      documentURL?: string;  
    }\>;  
    languages: string\[\];         // \["Thai", "English", "Chinese"\]  
  };  
    
  // Availability & Schedule  
  availability: {  
    workDays: {  
      monday: boolean;  
      tuesday: boolean;  
      wednesday: boolean;  
      thursday: boolean;  
      friday: boolean;  
      saturday: boolean;  
      sunday: boolean;  
    };  
    preferredShifts: Array\<{  
      start: string;             // "08:00"  
      end: string;               // "17:00"  
    }\>;  
    maxHoursPerWeek: number;  
    maxJobsPerDay: number;  
  };  
    
  // Leave & Time Off  
  leave: {  
    annualLeave: {  
      total: number;             // days per year  
      used: number;  
      remaining: number;  
    };  
    sickLeave: {  
      total: number;  
      used: number;  
      remaining: number;  
    };  
    upcomingLeave: Array\<{  
      startDate: string;  
      endDate: string;  
      type: 'annual' | 'sick' | 'personal' | 'emergency';  
      status: 'pending' | 'approved' | 'rejected';  
      reason?: string;  
    }\>;  
  };  
    
  // Performance Metrics  
  performance: {  
    totalJobsCompleted: number;  
    totalJobsCancelled: number;  
    averageRating: number;       // 0-5  
    ratings: Array\<{  
      bookingId: string;  
      rating: number;  
      review?: string;  
      createdAt: Timestamp;  
    }\>;  
    punctualityScore: number;    // 0-100  
    qualityScore: number;        // 0-100  
    customerSatisfactionScore: number; // 0-100  
    lastReviewDate?: Timestamp;  
  };  
    
  // Notes & Feedback  
  notes: {  
    strengths: string\[\];  
    areasForImprovement: string\[\];  
    adminNotes: string;          // Private notes from management  
    customerFeedback: Array\<{  
      bookingId: string;  
      feedback: string;  
      type: 'positive' | 'negative' | 'neutral';  
      createdAt: Timestamp;  
    }\>;  
  };  
    
  // Recognition & Awards  
  achievements: Array\<{  
    title: string;  
    description: string;  
    awardedDate: Timestamp;  
    awardedBy: string;           // Admin user ID  
  }\>;  
    
  // Financial (Optional \- for payroll integration)  
  compensation?: {  
    baseRate: number;            // per hour or per job  
    rateType: 'hourly' | 'per\_job' | 'monthly\_salary';  
    bankAccount?: {  
      bankName: string;  
      accountNumber: string;     // Encrypted  
      accountName: string;  
    };  
  };  
    
  // Status  
  status: 'active' | 'inactive' | 'on\_leave' | 'suspended' | 'terminated';  
  statusReason?: string;  
    
  // Preferences  
  preferences: {  
    preferredAreas: string\[\];    // \["Sukhumvit", "Sathorn"\]  
    maxTravelDistance: number;   // km  
    vehicleType?: 'motorcycle' | 'car' | 'public\_transport';  
  };  
    
  // Metadata  
  createdAt: Timestamp;  
  createdBy: string;  
  updatedAt: Timestamp;  
  updatedBy: string;  
    
  // Firebase Auth Link  
  authUid?: string;              // Link to Firebase Auth user (optional)  
}

#### **Collection: customers**

interface Customer {  
  id: string;  
  name: string;  
  phone: string;  
  email: string;  
  addresses: Array\<{  
    label: string;               // "Home", "Office"  
    address: string;  
    location?: {                 // (NEW)  
      lat: number;  
      lng: number;  
    };  
    isDefault: boolean;  
  }\>;  
  tags: string\[\];  
  preferences: {  
    preferredTime?: string\[\];  
    preferredStaff?: string\[\];   // (NEW) Array of staff IDs  
    allergies?: string\[\];  
    specialRequirements?: string;  
  };  
  stats: {  
    totalBookings: number;  
    completedBookings: number;  
    cancelledBookings: number;  
    lifetimeValue: number;  
    lastBookingDate?: Timestamp;  
    favoriteService?: string;    // (NEW)  
  };  
  createdAt: Timestamp;  
  updatedAt: Timestamp;  
}

#### **Collection: teams (NEW)**

interface Team {  
  id: string;  
  name: string;                  // "Team Alpha", "Weekend Crew"  
  description: string;  
    
  // Team Members  
  members: Array\<{  
    staffId: string;  
    role: 'lead' | 'member';  
    joinedAt: Timestamp;  
  }\>;  
    
  // Team Specialization  
  specialization: string\[\];      // \["Corporate Offices", "High-Rise Condos"\]  
    
  // Performance  
  stats: {  
    totalJobsCompleted: number;  
    averageRating: number;  
    successRate: number;         // % of jobs completed successfully  
  };  
    
  // Status  
  isActive: boolean;  
    
  // Metadata  
  createdAt: Timestamp;  
  createdBy: string;  
  updatedAt: Timestamp;  
}

#### **Collection: users (Admin/Staff)**

interface User {  
  id: string;                    // Firebase Auth UID  
  email: string;  
  displayName: string;  
  role: 'admin' | 'operator' | 'staff' | 'viewer';  
  permissions: string\[\];         // \["bookings:write", "customers:read", "staff:read"\]  
    
  profile: {  
    phoneNumber?: string;  
    photoURL?: string;  
  };  
    
  preferences: {  
    theme: 'light' | 'dark';  
    language: 'th' | 'en';  
    defaultView: 'calendar' | 'list';  
  };  
    
  // Link to staff profile if user is a staff member  
  staffId?: string;              // (NEW)  
    
  createdAt: Timestamp;  
  lastLoginAt: Timestamp;  
  isActive: boolean;  
}

#### **Collection: schedules (NEW \- for quick availability checks)**

interface ScheduleEntry {  
  id: string;  
  staffId: string;  
  date: string;                  // ISO date: "2025-10-15"  
    
  // Time blocks (15-min intervals)  
  timeBlocks: Array\<{  
    startTime: string;           // "09:00"  
    endTime: string;             // "13:00"  
    status: 'available' | 'booked' | 'blocked';  
    bookingId?: string;          // If booked  
    reason?: string;             // If blocked (e.g., "Personal appointment")  
  }\>;  
    
  // Quick lookup  
  isFullyBooked: boolean;  
  availableHours: number;  
    
  updatedAt: Timestamp;  
}

#### **Collection: staff\_performance\_logs (NEW \- for detailed tracking)**

interface PerformanceLog {  
  id: string;  
  staffId: string;  
  bookingId: string;  
    
  // Attendance  
  scheduledArrival: Timestamp;  
  actualArrival?: Timestamp;  
  scheduledDeparture: Timestamp;  
  actualDeparture?: Timestamp;  
  punctuality: 'on\_time' | 'early' | 'late' | 'no\_show';  
    
  // Quality Metrics  
  taskCompletion: number;        // 0-100%  
  qualityScore: number;          // 0-5 (from customer)  
  supervisorScore?: number;      // 0-5 (from admin/supervisor)  
    
  // Issues  
  issues: Array\<{  
    type: 'quality' | 'behavior' | 'safety' | 'other';  
    description: string;  
    severity: 'minor' | 'moderate' | 'severe';  
    reportedBy: string;  
    reportedAt: Timestamp;  
  }\>;  
    
  // Recognition  
  recognitions: Array\<{  
    type: 'customer\_praise' | 'above\_beyond' | 'efficiency';  
    description: string;  
    awardedBy: string;  
    awardedAt: Timestamp;  
  }\>;  
    
  createdAt: Timestamp;  
}

### **6.2 Indexes**

// Composite indexes for Firestore  
bookings: {  
  // Query: Get bookings by date range  
  \['schedule.date', 'status'\]: 'ASC',  
    
  // Query: Get customer booking history  
  \['customer.email', 'createdAt'\]: 'DESC',  
    
  // Query: Get staff assignments (NEW)  
  \['assignedTo.id', 'schedule.date'\]: 'ASC',  
    
  // Query: Search bookings  
  \['status', 'schedule.date'\]: 'ASC',  
    
  // Query: Find bookings by service type (NEW)  
  \['service.type', 'schedule.date'\]: 'ASC'  
}

staff: {  
  // Query: Find active staff by role (NEW)  
  \['status', 'employment.role'\]: 'ASC',  
    
  // Query: Staff performance ranking (NEW)  
  \['status', 'performance.averageRating'\]: 'DESC',  
    
  // Query: Find staff by skills (NEW)  
  \['status', 'skills.primary'\]: 'ASC'  
}

schedules: {  
  // Query: Check staff availability (NEW)  
  \['staffId', 'date'\]: 'ASC',  
    
  // Query: Find available staff for date (NEW)  
  \['date', 'isFullyBooked'\]: 'ASC'  
}

### **6.3 Data Validation Rules**

// Zod schemas for validation  
const bookingSchema \= z.object({  
  customer: z.object({  
    name: z.string().min(2, "ชื่อต้องมีอย่างน้อย 2 ตัวอักษร"),  
    phone: z.string().regex(/^0\\d{1,2}-\\d{3}-\\d{4}$/, "รูปแบบเบอร์โทรไม่ถูกต้อง"),  
    email: z.string().email("รูปแบบอีเมลไม่ถูกต้อง"),  
    address: z.string().min(10, "กรุณากรอกที่อยู่ให้ครบถ้วน")  
  }),  
  service: z.object({  
    type: z.enum(\['cleaning', 'training'\]),  
    category: z.enum(\['deep', 'regular', 'individual', 'corporate'\]),  
    name: z.string(),  
    requiredSkills: z.array(z.string()).optional()  
  }),  
  schedule: z.object({  
    date: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/),  
    time: z.string().regex(/^\\d{2}:\\d{2}$/),  
    duration: z.number().positive()  
  }),  
  notes: z.string().optional(),  
  assignedTo: z.object({  
    id: z.string(),  
    name: z.string()  
  }).optional()  
});

// NEW: Staff validation schema  
const staffSchema \= z.object({  
  personalInfo: z.object({  
    firstName: z.string().min(2),  
    lastName: z.string().min(2),  
    phone: z.string().regex(/^0\\d{1,2}-\\d{3}-\\d{4}$/),  
    email: z.string().email().optional()  
  }),  
  employment: z.object({  
    role: z.enum(\['cleaner', 'trainer', 'team\_lead', 'supervisor'\]),  
    employmentType: z.enum(\['full\_time', 'part\_time', 'contract', 'freelance'\]),  
    startDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/)  
  }),  
  skills: z.object({  
    primary: z.array(z.string()).min(1, "ต้องมีทักษะหลักอย่างน้อย 1 ทักษะ")  
  }),  
  availability: z.object({  
    workDays: z.object({  
      monday: z.boolean(),  
      tuesday: z.boolean(),  
      wednesday: z.boolean(),  
      thursday: z.boolean(),  
      friday: z.boolean(),  
      saturday: z.boolean(),  
      sunday: z.boolean()  
    }),  
    maxHoursPerWeek: z.number().min(1).max(60),  
    maxJobsPerDay: z.number().min(1).max(10)  
  })  
});  
