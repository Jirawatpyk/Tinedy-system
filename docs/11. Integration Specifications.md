# **11\. Integration Specifications**

### **11.1 N8N Workflow Integration**

#### **Workflow 1: Booking Confirmation**

Trigger: Webhook (booking.created)  
‚Üì  
Node 1: Extract booking details  
‚Üì  
Node 2: Send Email (SendGrid)  
  \- To: customer.email  
  \- Template: booking-confirmation  
  \- Data: {bookingId, date, time, service}  
‚Üì  
Node 3: Send Line Message  
  \- To: customer.lineId (if available)  
  \- Message: "Your booking is confirmed..."  
‚Üì  
Node 4: Notify Assigned Staff (NEW)  
  \- To: staff.lineId or staff.phone  
  \- Message: "New assignment: {customer} at {time}"  
  \- Include: booking details, customer address, notes  
‚Üì  
Node 5: Create Google Calendar Event (optional)  
  \- Calendar: team@tinedy.com  
  \- Event: {title, start, end, location, description}  
‚Üì  
Node 6: Update Firestore  
  \- Set: notificationsSent \= true

#### **Workflow 2: Booking Reminder**

Trigger: Schedule (daily at 9:00 AM)  
‚Üì  
Node 1: Query Firestore  
  \- Get bookings where:  
    \- schedule.date \= tomorrow  
    \- status \= confirmed  
‚Üì  
Node 2: For Each booking  
  ‚Üì  
  Node 2a: Send SMS to Customer (Twilio)  
    \- To: customer.phone  
    \- Message: "Reminder: Your Tinedy service tomorrow at {time}"  
  ‚Üì  
  Node 2b: Send Reminder to Staff (NEW)  
    \- To: assigned staff  
    \- Message: "Reminder: Job tomorrow at {time}, {address}"  
  ‚Üì  
  Node 2c: Log to Firestore  
    \- Collection: notifications  
    \- Document: {bookingId, type: 'reminder', sentAt}

#### **Workflow 3: Post-Service Feedback**

Trigger: Webhook (booking.status\_changed to 'completed')  
‚Üì  
Node 1: Wait 2 hours  
‚Üì  
Node 2: Send Feedback Request to Customer  
  \- Channel: Email \+ Line  
  \- Content: "How was your experience?"  
  \- Link: feedback form with pre-filled bookingId  
‚Üì  
Node 3: If response received within 48 hours  
  ‚Üì  
  Store in Firestore: bookings/{id}/feedback  
  ‚Üì  
  If rating \< 3: Alert admin via Line  
  ‚Üì  
  Update staff performance record (NEW)

#### **Workflow 4: Staff Assignment Notification (NEW)**

Trigger: Webhook (staff.assigned to booking)  
‚Üì  
Node 1: Get staff contact info  
‚Üì  
Node 2: Send notification  
  \- Via: Line/SMS (staff preference)  
  \- Include:  
    \- Booking details  
    \- Customer name & phone  
    \- Service address with map link  
    \- Special requirements/notes  
    \- Estimated travel time  
‚Üì  
Node 3: Request confirmation  
  \- Staff replies to accept/decline  
  \- Update booking.assignedTo.status

#### **Workflow 5: Staff Performance Alert (NEW)**

Trigger: Schedule (weekly on Monday 9:00 AM)  
‚Üì  
Node 1: Query performance data  
  \- Get staff with rating \< 3.5 last 30 days  
  \- Get staff with \> 3 late arrivals  
  \- Get staff with \> 2 customer complaints  
‚Üì  
Node 2: Generate performance report  
  \- For each flagged staff  
  \- Include: metrics, issues, trends  
‚Üì  
Node 3: Send to admin  
  \- Via: Email \+ Line  
  \- Include: recommended actions

#### **Workflow 6: Leave Request (NEW)**

Trigger: Webhook (staff.leave\_requested)  
‚Üì  
Node 1: Check affected bookings  
  \- Query bookings in leave date range  
  \- Filter: assignedTo.id \= staffId  
‚Üì  
Node 2: Send admin notification  
  \- To: admin Line/Email  
  \- Include:  
    \- Staff name  
    \- Leave dates  
    \- Reason  
    \- Affected bookings count  
    \- Action buttons: Approve / Reject  
‚Üì  
Node 3: If approved  
  ‚Üì  
  Update staff.leave  
  ‚Üì  
  For each affected booking:  
    \- Remove staff assignment  
    \- Find alternative staff  
    \- Send reassignment notification

### **11.2 Webhook Security**

// Verify N8N webhook signature  
import crypto from 'crypto';

function verifyWebhookSignature(  
  payload: string,  
  signature: string,  
  secret: string  
): boolean {  
  const expectedSignature \= crypto  
    .createHmac('sha256', secret)  
    .update(payload)  
    .digest('hex');  
    
  return crypto.timingSafeEqual(  
    Buffer.from(signature),  
    Buffer.from(expectedSignature)  
  );  
}

// API route handler  
export async function POST(request: Request) {  
  const signature \= request.headers.get('x-n8n-signature');  
  const body \= await request.text();  
    
  if (\!verifyWebhookSignature(body, signature, process.env.N8N\_SECRET)) {  
    return new Response('Unauthorized', { status: 401 });  
  }  
    
  // Process webhook...  
}

### **11.3 Line OA Integration (Future)**

// Line Messaging API  
import { Client } from '@line/bot-sdk';

const lineClient \= new Client({  
  channelAccessToken: process.env.LINE\_CHANNEL\_ACCESS\_TOKEN,  
  channelSecret: process.env.LINE\_CHANNEL\_SECRET  
});

// Send booking confirmation  
async function sendBookingConfirmation(lineUserId: string, booking: Booking) {  
  await lineClient.pushMessage(lineUserId, {  
    type: 'flex',  
    altText: 'Booking Confirmation',  
    contents: {  
      type: 'bubble',  
      body: {  
        type: 'box',  
        layout: 'vertical',  
        contents: \[  
          {  
            type: 'text',  
            text: 'Booking Confirmed',  
            weight: 'bold',  
            size: 'xl'  
          },  
          {  
            type: 'box',  
            layout: 'vertical',  
            margin: 'lg',  
            spacing: 'sm',  
            contents: \[  
              {  
                type: 'box',  
                layout: 'baseline',  
                spacing: 'sm',  
                contents: \[  
                  { type: 'text', text: 'Service', flex: 1 },  
                  { type: 'text', text: booking.service.name, flex: 2 }  
                \]  
              },  
              // ... more details  
            \]  
          }  
        \]  
      }  
    }  
  });  
}

// NEW: Send staff assignment notification  
async function sendStaffAssignment(lineUserId: string, booking: Booking) {  
  await lineClient.pushMessage(lineUserId, {  
    type: 'flex',  
    altText: 'New Job Assignment',  
    contents: {  
      type: 'bubble',  
      body: {  
        type: 'box',  
        layout: 'vertical',  
        contents: \[  
          {  
            type: 'text',  
            text: 'üîî ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',  
            weight: 'bold',  
            size: 'xl',  
            color: '\#1DB446'  
          },  
          {  
            type: 'text',  
            text: booking.service.name,  
            size: 'lg',  
            margin: 'md'  
          },  
          {  
            type: 'separator',  
            margin: 'lg'  
          },  
          {  
            type: 'box',  
            layout: 'vertical',  
            margin: 'lg',  
            spacing: 'sm',  
            contents: \[  
              {  
                type: 'box',  
                layout: 'baseline',  
                contents: \[  
                  { type: 'text', text: 'üìÖ', size: 'sm' },  
                  { type: 'text', text: booking.schedule.date, size: 'sm' }  
                \]  
              },  
              {  
                type: 'box',  
                layout: 'baseline',  
                contents: \[  
                  { type: 'text', text: 'üïê', size: 'sm' },  
                  { type: 'text', text: booking.schedule.time, size: 'sm' }  
                \]  
              },  
              {  
                type: 'box',  
                layout: 'baseline',  
                contents: \[  
                  { type: 'text', text: 'üìç', size: 'sm' },  
                  { type: 'text', text: booking.customer.address, wrap: true, size: 'sm' }  
                \]  
              },  
              {  
                type: 'box',  
                layout: 'baseline',  
                contents: \[  
                  { type: 'text', text: 'üë§', size: 'sm' },  
                  { type: 'text', text: booking.customer.name, size: 'sm' }  
                \]  
              },  
              {  
                type: 'box',  
                layout: 'baseline',  
                contents: \[  
                  { type: 'text', text: 'üìû', size: 'sm' },  
                  { type: 'text', text: booking.customer.phone, size: 'sm' }  
                \]  
              }  
            \]  
          }  
        \]  
      },  
      footer: {  
        type: 'box',  
        layout: 'horizontal',  
        spacing: 'sm',  
        contents: \[  
          {  
            type: 'button',  
            style: 'primary',  
            action: {  
              type: 'postback',  
              label: '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô',  
              data: \`action=accept\&bookingId=${booking.id}\`  
            }  
          },  
          {  
            type: 'button',  
            style: 'secondary',  
            action: {  
              type: 'postback',  
              label: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',  
              data: \`action=decline\&bookingId=${booking.id}\`  
            }  
          }  
        \]  
      }  
    }  
  });  
}  
