# **9\. Security & Compliance**

### **9.1 Authentication & Authorization**

#### **Firebase Authentication**

// Authentication methods  
\- Email/Password (primary)  
\- Google Sign-In (optional for admin convenience)

// Password requirements  
\- Minimum 10 characters  
\- Must include: uppercase, lowercase, number, special character  
\- No common passwords (dictionary check)  
\- Password history: last 5 passwords cannot be reused

#### **Role-Based Access Control (RBAC)**

const permissions \= {  
  admin: \[  
    'bookings:\*',        // Full CRUD  
    'customers:\*',  
    'staff:\*',           // (NEW) Full access to staff management  
    'teams:\*',  
    'users:\*',  
    'analytics:read',  
    'settings:\*'  
  \],  
  operator: \[  
    'bookings:read',  
    'bookings:create',  
    'bookings:update',  
    'customers:read',  
    'customers:create',  
    'staff:read',        // (NEW) Can view staff  
    'staff:assign',      // (NEW) Can assign staff to bookings  
    'teams:read'  
  \],  
  staff: \[              // (NEW) Staff member role  
    'bookings:read',     // Only assigned bookings  
    'bookings:update\_status',  // Can update job status  
    'schedule:read',     // Own schedule only  
    'performance:read'   // Own performance only  
  \],  
  viewer: \[  
    'bookings:read',  
    'customers:read',  
    'staff:read',  
    'analytics:read'  
  \]  
};

#### **Security Rules (Firestore)**

rules\_version \= '2';  
service cloud.firestore {  
  match /databases/{database}/documents {  
      
    // Helper functions  
    function isAuthenticated() {  
      return request.auth \!= null;  
    }  
      
    function hasRole(role) {  
      return isAuthenticated() &&   
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role \== role;  
    }  
      
    function isAdmin() {  
      return hasRole('admin');  
    }  
      
    function isStaffMember(staffId) {  
      return isAuthenticated() &&  
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.staffId \== staffId;  
    }  
      
    // Bookings collection  
    match /bookings/{bookingId} {  
      allow read: if isAuthenticated();  
      allow create: if isAuthenticated() &&   
                    (hasRole('admin') || hasRole('operator'));  
      allow update: if isAuthenticated() &&   
                    (hasRole('admin') || hasRole('operator') ||  
                     (hasRole('staff') &&   
                      resource.data.assignedTo.id \== request.auth.uid));  
      allow delete: if isAdmin();  
    }  
      
    // Customers collection  
    match /customers/{customerId} {  
      allow read: if isAuthenticated();  
      allow write: if isAdmin() || hasRole('operator');  
    }  
      
    // Staff collection (NEW)  
    match /staff/{staffId} {  
      allow read: if isAuthenticated();  
      allow create, update, delete: if isAdmin();  
        
      // Staff can update their own availability and preferences  
      allow update: if isStaffMember(staffId) &&  
                    request.resource.data.diff(resource.data).affectedKeys()  
                      .hasOnly(\['availability', 'preferences', 'leave'\]);  
    }  
      
    // Staff performance logs (NEW)  
    match /staff\_performance\_logs/{logId} {  
      allow read: if isAuthenticated() &&  
                  (isAdmin() || hasRole('operator') ||  
                   isStaffMember(resource.data.staffId));  
      allow write: if isAdmin() || hasRole('operator');  
    }  
      
    // Users collection  
    match /users/{userId} {  
      allow read: if isAuthenticated();  
      allow write: if isAdmin() || request.auth.uid \== userId;  
    }  
      
    // Teams collection  
    match /teams/{teamId} {  
      allow read: if isAuthenticated();  
      allow write: if isAdmin();  
    }  
      
    // Schedules collection (NEW)  
    match /schedules/{scheduleId} {  
      allow read: if isAuthenticated();  
      allow write: if isAdmin() || hasRole('operator');  
    }  
  }  
}

### **9.2 Data Privacy & Protection**

#### **Personal Data Handling (PDPA Compliance)**

// PII (Personally Identifiable Information) fields  
const piiFields \= \[  
  'customer.name',  
  'customer.phone',  
  'customer.email',  
  'customer.address',  
  'staff.personalInfo.nationalId',  // (NEW) Encrypted  
  'staff.personalInfo.phone',  
  'staff.emergencyContact',  
  'staff.compensation.bankAccount'  // (NEW) Encrypted  
\];

// Data retention policy  
const retentionPolicies \= {  
  activeBookings: 'indefinite',      // While customer is active  
  completedBookings: '3 years',      // For tax/accounting  
  cancelledBookings: '1 year',  
  deletedCustomers: '30 days',       // Soft delete period  
  staffRecords: '7 years',           // (NEW) After employment ends  
  performanceLogs: '3 years',        // (NEW)  
  auditLogs: '7 years'               // Regulatory requirement  
};

// Data export (PDPA right to data portability)  
async function exportStaffData(staffId: string) {  // (NEW)  
  return {  
    personalInfo: { /\* ... \*/ },  
    employmentHistory: \[ /\* ... \*/ \],  
    performanceRecords: \[ /\* ... \*/ \],  
    bookingHistory: \[ /\* ... \*/ \],  
    exportedAt: new Date().toISOString(),  
    format: 'JSON'  
  };  
}

// Data deletion (PDPA right to erasure)  
async function deleteStaffData(staffId: string) {  // (NEW)  
  // 1\. Anonymize PII in historical bookings  
  // 2\. Anonymize PII in performance logs  
  // 3\. Mark staff as "deleted" (soft delete)  
  // 4\. Remove from all indexes  
  // 5\. Log deletion for compliance  
}

#### **Encryption**

* **At Rest:** Firebase handles encryption automatically  
* **In Transit:** HTTPS/TLS 1.3 only  
* **Sensitive Fields:** Additional encryption for:  
  * Staff national ID numbers  
  * Bank account information  
  * Compensation details

#### **Audit Logging**

interface AuditLog {  
  timestamp: Timestamp;  
  userId: string;  
  userEmail: string;  
  action: string;              // "booking.created", "staff.hired", "staff.deleted"  
  resource: string;            // "bookings/abc123", "staff/xyz789"  
  changes?: {  
    before: Record\<string, any\>;  
    after: Record\<string, any\>;  
  };  
  ipAddress: string;  
  userAgent: string;  
}

// Log all CUD operations (Create, Update, Delete)  
// Especially important for:  
// \- Staff hire/termination  
// \- Performance log modifications  
// \- Compensation changes  
// \- Booking assignments

### **9.3 API Security**

#### **Rate Limiting**

// Per IP address  
const rateLimits \= {  
  authenticated: {  
    windowMs: 60000,           // 1 minute  
    maxRequests: 100  
  },  
  unauthenticated: {  
    windowMs: 60000,  
    maxRequests: 20  
  },  
  webhooks: {  
    windowMs: 60000,  
    maxRequests: 500           // Higher for N8N integration  
  },  
  staffPortal: {               // (NEW) For staff mobile access  
    windowMs: 60000,  
    maxRequests: 50  
  }  
};

#### **Input Validation & Sanitization**

// Server-side validation (critical)  
import { z } from 'zod';

const bookingSchema \= z.object({  
  customer: z.object({  
    name: z.string()  
      .min(2).max(100)  
      .regex(/^\[ก-๏a-zA-Z\\s\]+$/), // Thai/English letters only  
    phone: z.string()  
      .regex(/^0\\d{1,2}-\\d{3}-\\d{4}$/),  
    email: z.string().email().toLowerCase(),  
    address: z.string().min(10).max(500)  
  }),  
  // ... other fields  
});

// NEW: Staff validation  
const staffSchema \= z.object({  
  personalInfo: z.object({  
    firstName: z.string().min(2).max(50),  
    lastName: z.string().min(2).max(50),  
    nationalId: z.string()  
      .regex(/^\\d{13}$/)        // Thai national ID format  
      .transform(encryptNationalId),  // Encrypt before storage  
    phone: z.string().regex(/^0\\d{1,2}-\\d{3}-\\d{4}$/),  
  }),  
  // ... other fields  
});

// Sanitize HTML inputs to prevent XSS  
import DOMPurify from 'isomorphic-dompurify';  
const sanitized \= DOMPurify.sanitize(userInput);

#### **CORS Configuration**

// next.config.js  
const corsHeaders \= {  
  'Access-Control-Allow-Origin': process.env.ALLOWED\_ORIGINS,  
  'Access-Control-Allow-Methods': 'GET,POST,PUT,PATCH,DELETE,OPTIONS',  
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',  
  'Access-Control-Max-Age': '86400', // 24 hours  
};

### **9.4 Security Best Practices**

#### **Environment Variables**

\# .env.local (never commit to git)  
NEXT\_PUBLIC\_FIREBASE\_API\_KEY=...  
NEXT\_PUBLIC\_FIREBASE\_AUTH\_DOMAIN=...  
NEXT\_PUBLIC\_FIREBASE\_PROJECT\_ID=...

\# Server-side only  
FIREBASE\_ADMIN\_PRIVATE\_KEY=...  
N8N\_WEBHOOK\_SECRET=...  
SENDGRID\_API\_KEY=...  
ENCRYPTION\_KEY=...              \# NEW: For sensitive data encryption

#### **Content Security Policy (CSP)**

// next.config.js  
const csp \= \`  
  default-src 'self';  
  script-src 'self' 'unsafe-eval' 'unsafe-inline' \[https://apis.google.com\](https://apis.google.com);  
  style-src 'self' 'unsafe-inline' \[https://fonts.googleapis.com\](https://fonts.googleapis.com);  
  img-src 'self' data: https: blob:;  
  font-src 'self' \[https://fonts.gstatic.com\](https://fonts.gstatic.com);  
  connect-src 'self' https://\*.googleapis.com https://\*.firebase.com;  
  frame-src 'self' https://\*.firebaseapp.com;  
\`;  
