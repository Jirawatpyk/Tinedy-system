# Risk Profile: Story 1.3 - Authentication & Admin Login

**Generated**: 2025-10-04
**Reviewer**: Quinn (Test Architect)
**Story**: 1.3 - Authentication & Admin Login
**Status**: CONCERNS

---

## Risk Assessment Matrix

| Risk ID | Category | Description | Probability | Impact | Score | Priority |
|---------|----------|-------------|-------------|--------|-------|----------|
| SEC-001 | Security | No server-side route protection | High (3) | Critical (3) | **9** | P0 |
| TEST-001 | Quality | No automated tests | High (3) | High (3) | **9** | P0 |
| SEC-002 | Security | Session verification endpoint unused | Medium (2) | High (3) | **6** | P1 |
| PERF-001 | Performance | Double session creation | Medium (2) | Medium (2) | **4** | P1 |
| DOC-001 | Maintainability | No documentation | High (3) | Low (1) | **3** | P2 |
| A11Y-001 | Accessibility | Password toggle not keyboard accessible | Low (1) | Low (1) | **1** | P3 |

**Risk Scoring**: Probability (1-3) √ó Impact (1-3) = Score (1-9)
- **9**: Critical - Immediate action required
- **6-8**: High - Must address before production
- **3-5**: Medium - Should address soon
- **1-2**: Low - Monitor and fix when convenient

---

## Critical Risks (Score ‚â• 9)

### SEC-001: No Server-Side Route Protection

**Description**:
Middleware.ts was removed due to Next.js 15 Edge Runtime compatibility issues. Current implementation uses client-side protection only via AuthContext.

**Evidence**:
```typescript
// lib/auth/AuthContext.tsx (client-side only)
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
    setUser(firebaseUser);
    // No server-side verification
  });
}, []);
```

**Attack Scenario**:
1. User disables JavaScript
2. Directly navigates to `/` or other protected routes
3. Server renders page without auth check
4. User gains unauthorized access

**Impact**:
- ‚ö†Ô∏è OWASP A01:2021 - Broken Access Control
- Unauthorized users can access admin dashboard
- Potential data breach if sensitive info rendered server-side

**Mitigation**:
```typescript
// Recommended: app/(protected)/layout.tsx
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';
import { adminAuth } from '@/lib/firebase/admin';

export default async function ProtectedLayout({ children }) {
  const sessionCookie = cookies().get('session')?.value;

  if (!sessionCookie) {
    redirect('/login');
  }

  try {
    await adminAuth.verifySessionCookie(sessionCookie, true);
  } catch {
    redirect('/login');
  }

  return <>{children}</>;
}
```

**Priority**: P0 - Must fix before production
**Owner**: Dev

---

### TEST-001: No Automated Tests

**Description**:
Zero automated tests exist. Manual testing only planned (Story line 60-64).

**Missing Test Coverage**:
- ‚ùå Unit tests: Error mapping, validation schemas
- ‚ùå Integration tests: API routes, session management
- ‚ùå E2E tests: Login flow, protected routes, logout

**Impact**:
- Cannot verify security controls programmatically
- High risk of regression when code changes
- Breaks on authentication = breaks entire application

**Recommended Tests (P0)**:
```typescript
// e2e/auth.spec.ts
test('unauthorized access redirects to login', async ({ page }) => {
  await page.goto('/');
  await expect(page).toHaveURL('/login');
});

test('valid login grants access', async ({ page }) => {
  await page.goto('/login');
  await page.fill('[name="email"]', 'admin@test.com');
  await page.fill('[name="password"]', 'password');
  await page.click('button[type="submit"]');
  await expect(page).toHaveURL('/');
});

// app/api/auth/session/__tests__/route.test.ts
it('creates session cookie with valid token', async () => {
  const response = await POST(mockRequest);
  expect(response.cookies.get('session')).toBeDefined();
});
```

**Priority**: P0 - Must have before production
**Owner**: Dev

---

## High Risks (Score 6-8)

### SEC-002: Session Verification Endpoint Unused

**Description**:
API route `/api/auth/verify` exists but is never called. Session cookies created but not verified.

**Evidence**:
- ‚úÖ [app/api/auth/verify/route.ts](C:\Tinedy system\tinedy-app\app\api\auth\verify\route.ts) - Endpoint exists
- ‚ùå No calls to this endpoint in codebase
- ‚ùå Protected pages don't verify session

**Impact**:
- Session cookies could be tampered with
- No server-side session validation
- False sense of security

**Mitigation**:
```typescript
// lib/auth/withAuth.tsx (HOC wrapper)
export function withAuth<P extends object>(Component: ComponentType<P>) {
  return async function AuthenticatedComponent(props: P) {
    const sessionCookie = cookies().get('session')?.value;

    if (!sessionCookie) {
      redirect('/login');
    }

    // Verify session
    const response = await fetch('/api/auth/verify', {
      headers: { Cookie: `session=${sessionCookie}` },
    });

    if (!response.ok) {
      redirect('/login');
    }

    return <Component {...props} />;
  };
}
```

**Priority**: P1 - Must address before production
**Owner**: Dev

---

## Medium Risks (Score 3-5)

### PERF-001: Double Session Creation

**Description**:
Session cookie created twice on login - once in login page, again in AuthContext.

**Evidence**:
- [app/login/page.tsx:62-67](C:\Tinedy system\tinedy-app\app\login\page.tsx#L62-L67): First creation
- [lib/auth/AuthContext.tsx:48-52](C:\Tinedy system\tinedy-app\lib\auth\AuthContext.tsx#L48-L52): Duplicate creation

**Impact**:
- Unnecessary API call (~100-200ms overhead)
- Potential race condition if both calls happen simultaneously
- Wasted server resources

**Mitigation**:
Remove duplicate call from AuthContext - login page already handles it.

**Priority**: P1 - Should fix soon
**Owner**: Dev

---

### DOC-001: No Documentation

**Description**:
Zero JSDoc comments or inline documentation across all files.

**Impact**:
- Reduced maintainability
- Unclear function contracts
- New developers struggle to understand code

**Mitigation**:
Add JSDoc per coding standards (docs/architecture/coding-standards.md:479-495)

**Priority**: P2 - Address in next sprint
**Owner**: Dev

---

## Low Risks (Score 1-2)

### A11Y-001: Password Toggle Accessibility

**Description**:
Password visibility toggle button has `tabIndex={-1}`, removing it from keyboard navigation.

**Evidence**:
[app/login/page.tsx:151](C:\Tinedy system\tinedy-app\app\login\page.tsx#L151)

**Impact**:
- Keyboard users cannot toggle password visibility
- WCAG 2.1 AA compliance issue

**Mitigation**:
```typescript
// Remove tabIndex or set to 0
<button
  type="button"
  // tabIndex={-1}  ‚ùå Remove this
  onClick={() => setShowPassword(!showPassword)}
  aria-label={showPassword ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'}
>
```

**Priority**: P3 - Fix when convenient
**Owner**: Dev

---

## Risk Mitigation Plan

### Immediate (Before Production)
1. ‚úÖ **Implement server-side route protection** (SEC-001)
   - Create protected layout with session verification
   - Estimated effort: 2-4 hours

2. ‚úÖ **Add P0 automated tests** (TEST-001)
   - E2E: Unauthorized access, login flow, logout
   - Integration: Session API routes
   - Estimated effort: 4-6 hours

3. ‚úÖ **Use session verification endpoint** (SEC-002)
   - Create withAuth HOC
   - Apply to protected pages
   - Estimated effort: 2-3 hours

### Short-term (Next Sprint)
4. ‚è≠Ô∏è **Fix double session creation** (PERF-001)
   - Refactor AuthContext
   - Estimated effort: 1 hour

5. ‚è≠Ô∏è **Add JSDoc documentation** (DOC-001)
   - Document all public functions
   - Estimated effort: 2-3 hours

### Long-term (Future)
6. üìÖ **Fix accessibility issue** (A11Y-001)
   - Remove tabIndex={-1}
   - Estimated effort: 5 minutes

---

## Overall Risk Summary

| Risk Level | Count | Percentage |
|------------|-------|------------|
| Critical (9) | 2 | 33% |
| High (6-8) | 1 | 17% |
| Medium (3-5) | 2 | 33% |
| Low (1-2) | 1 | 17% |

**Overall Risk Rating**: **HIGH** ‚ö†Ô∏è

**Production Readiness**: **NOT READY** ‚ùå
- Must resolve SEC-001 and TEST-001 before production deployment
- Current state acceptable for development/testing only

**Recommended Action**:
- ‚úÖ Approve for merge to development branch
- ‚ö†Ô∏è Block production deployment until P0 risks mitigated
- üìã Create follow-up story for server-side protection + tests

---

## Related Documents

- **Quality Gate**: [docs/qa/gates/1.3-authentication-admin-login.yml](../gates/1.3-authentication-admin-login.yml)
- **Story**: [docs/stories/1.3.authentication-admin-login.md](../../stories/1.3.authentication-admin-login.md)
- **Architecture**: [docs/architecture/Tinedy - Architecture - Core Booking.md](../../architecture/Tinedy - Architecture - Core Booking.md)
- **Coding Standards**: [docs/architecture/coding-standards.md](../../architecture/coding-standards.md)
