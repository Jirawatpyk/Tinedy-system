# **7\. API Specifications**

### **7.1 RESTful API Endpoints**

#### **Bookings API**

**GET /api/bookings**

// Query parameters  
interface GetBookingsQuery {  
  status?: 'pending' | 'confirmed' | 'in\_progress' | 'completed' | 'cancelled' | 'all';  
  startDate?: string;          // ISO date  
  endDate?: string;            // ISO date  
  customerId?: string;  
  staffId?: string;            // (NEW) Filter by assigned staff  
  teamId?: string;             // (NEW) Filter by team  
  search?: string;             // Search in customer name, phone, email  
  page?: number;  
  limit?: number;              // Max 100  
  sortBy?: 'date' | 'createdAt' | 'customerName' | 'staffName';  
  sortOrder?: 'asc' | 'desc';  
}

// Response  
interface GetBookingsResponse {  
  bookings: Booking\[\];  
  pagination: {  
    page: number;  
    limit: number;  
    total: number;  
    totalPages: number;  
  };  
  meta: {  
    statusCounts: {  
      pending: number;  
      confirmed: number;  
      in\_progress: number;  
      completed: number;  
      cancelled: number;  
    };  
    staffUtilization?: {       // (NEW)  
      assigned: number;  
      available: number;  
      percentage: number;  
    };  
  };  
}

**POST /api/bookings**

// Request body  
interface CreateBookingRequest {  
  customer: {  
    name: string;  
    phone: string;  
    email: string;  
    address: string;  
  };  
  service: {  
    type: 'cleaning' | 'training';  
    category: string;  
    name: string;  
    requiredSkills?: string\[\];  // (NEW)  
  };  
  schedule: {  
    date: string;  
    time: string;  
    duration: number;  
  };  
  notes?: string;  
  assignedStaffId?: string;     // (NEW) Optional immediate assignment  
  status?: 'pending' | 'confirmed';  
}

// Response  
interface CreateBookingResponse {  
  booking: Booking;  
  message: string;  
  suggestedStaff?: Array\<{      // (NEW) If no staff assigned  
    staffId: string;  
    name: string;  
    matchScore: number;         // 0-100 based on skills & availability  
    availableAt: string;  
  }\>;  
}

**PATCH /api/bookings/:id/assign**

// (NEW) Endpoint specifically for assigning staff  
interface AssignStaffRequest {  
  staffId: string;  
  notifyStaff?: boolean;        // Send notification  
}

interface AssignStaffResponse {  
  booking: Booking;  
  conflictWarning?: string;     // If staff has nearby bookings  
  message: string;  
}

#### **Staff API (NEW)**

**GET /api/staff**

interface GetStaffQuery {  
  status?: 'active' | 'inactive' | 'on\_leave' | 'all';  
  role?: 'cleaner' | 'trainer' | 'team\_lead' | 'supervisor';  
  skills?: string\[\];            // Filter by skills  
  availableOn?: string;         // ISO date \- filter by availability  
  search?: string;              // Search by name, phone  
  page?: number;  
  limit?: number;  
  sortBy?: 'name' | 'rating' | 'jobsCompleted';  
  sortOrder?: 'asc' | 'desc';  
}

interface GetStaffResponse {  
  staff: StaffMember\[\];  
  pagination: PaginationMeta;  
  meta: {  
    totalActive: number;  
    totalInactive: number;  
    averageRating: number;  
  };  
}

**POST /api/staff**

interface CreateStaffRequest {  
  personalInfo: {  
    firstName: string;  
    lastName: string;  
    nickname?: string;  
    phone: string;  
    email?: string;  
    // ... other fields  
  };  
  employment: {  
    role: string;  
    employmentType: string;  
    startDate: string;  
  };  
  skills: {  
    primary: string\[\];  
    secondary?: string\[\];  
  };  
  availability: {  
    workDays: Record\<string, boolean\>;  
    maxHoursPerWeek: number;  
    maxJobsPerDay: number;  
  };  
}

interface CreateStaffResponse {  
  staff: StaffMember;  
  message: string;  
}

**GET /api/staff/:id**

interface GetStaffDetailResponse {  
  staff: StaffMember;  
  upcomingBookings: Booking\[\];  
  recentPerformance: {  
    last30Days: {  
      jobsCompleted: number;  
      averageRating: number;  
      onTimePercentage: number;  
    };  
  };  
}

**PATCH /api/staff/:id**

// Partial update  
interface UpdateStaffRequest {  
  personalInfo?: Partial\<StaffMember\['personalInfo'\]\>;  
  employment?: Partial\<StaffMember\['employment'\]\>;  
  skills?: Partial\<StaffMember\['skills'\]\>;  
  availability?: Partial\<StaffMember\['availability'\]\>;  
  status?: StaffMember\['status'\];  
}

**GET /api/staff/:id/schedule**

interface GetStaffScheduleQuery {  
  startDate: string;  
  endDate: string;  
}

interface GetStaffScheduleResponse {  
  staffId: string;  
  staffName: string;  
  schedule: Array\<{  
    date: string;  
    bookings: Booking\[\];  
    availableHours: number;  
    totalHours: number;  
    utilization: number;        // percentage  
  }\>;  
}

**POST /api/staff/:id/leave**

interface RequestLeaveRequest {  
  startDate: string;  
  endDate: string;  
  type: 'annual' | 'sick' | 'personal' | 'emergency';  
  reason?: string;  
}

interface RequestLeaveResponse {  
  leaveRequest: StaffMember\['leave'\]\['upcomingLeave'\]\[0\];  
  message: string;  
  affectedBookings?: Booking\[\];  // Bookings that need reassignment  
}

#### **Staff Availability API (NEW)**

**GET /api/staff/available**

interface CheckAvailabilityQuery {  
  date: string;                 // ISO date  
  startTime: string;            // "09:00"  
  duration: number;             // minutes  
  requiredSkills?: string\[\];  
  excludeStaffIds?: string\[\];   // Exclude specific staff  
}

interface CheckAvailabilityResponse {  
  availableStaff: Array\<{  
    staff: StaffMember;  
    matchScore: number;         // 0-100  
    availableFrom: string;  
    availableUntil: string;  
    previousBooking?: {  
      endTime: string;  
      address: string;  
      travelTime: number;       // estimated minutes  
    };  
    nextBooking?: {  
      startTime: string;  
      address: string;  
    };  
  }\>;  
  unavailableStaff: Array\<{  
    staffId: string;  
    name: string;  
    reason: 'booked' | 'on\_leave' | 'off\_duty' | 'overbooked';  
    availableAt?: string;       // Next available time  
  }\>;  
}

#### **Staff Performance API (NEW)**

**GET /api/staff/:id/performance**

interface GetPerformanceQuery {  
  startDate?: string;  
  endDate?: string;  
  period?: 'week' | 'month' | 'quarter' | 'year';  
}

interface GetPerformanceResponse {  
  staffId: string;  
  staffName: string;  
  period: {  
    startDate: string;  
    endDate: string;  
  };  
  metrics: {  
    totalJobsCompleted: number;  
    totalJobsCancelled: number;  
    completionRate: number;     // percentage  
    averageRating: number;  
    punctualityScore: number;  
    qualityScore: number;  
    customerSatisfactionScore: number;  
  };  
  ratings: Array\<{  
    bookingId: string;  
    customerName: string;  
    rating: number;  
    review?: string;  
    date: string;  
  }\>;  
  issues: Array\<{  
    date: string;  
    type: string;  
    description: string;  
    severity: string;  
  }\>;  
  achievements: Array\<{  
    title: string;  
    date: string;  
  }\>;  
}

**POST /api/staff/:id/performance/log**

interface LogPerformanceRequest {  
  bookingId: string;  
  punctuality: 'on\_time' | 'early' | 'late' | 'no\_show';  
  actualArrival?: string;       // ISO timestamp  
  actualDeparture?: string;  
  qualityScore?: number;        // 0-5  
  supervisorScore?: number;  
  issues?: Array\<{  
    type: string;  
    description: string;  
    severity: string;  
  }\>;  
  recognitions?: Array\<{  
    type: string;  
    description: string;  
  }\>;  
  notes?: string;  
}

#### **Teams API (NEW)**

**GET /api/teams**

interface GetTeamsResponse {  
  teams: Team\[\];  
  pagination: PaginationMeta;  
}

**POST /api/teams**

interface CreateTeamRequest {  
  name: string;  
  description: string;  
  memberIds: string\[\];  
  leadId: string;               // One member must be designated as lead  
  specialization: string\[\];  
}

**POST /api/teams/:id/assign**

interface AssignTeamRequest {  
  bookingId: string;  
}

interface AssignTeamResponse {  
  booking: Booking;  
  team: Team;  
  message: string;  
}

#### **Analytics API (NEW \- Enhanced)**

**GET /api/analytics/staff-utilization**

interface StaffUtilizationQuery {  
  startDate: string;  
  endDate: string;  
  staffIds?: string\[\];          // Specific staff or all  
}

interface StaffUtilizationResponse {  
  period: { startDate: string; endDate: string; };  
  overall: {  
    totalStaff: number;  
    averageUtilization: number; // percentage  
    totalHoursWorked: number;  
    totalHoursAvailable: number;  
  };  
  byStaff: Array\<{  
    staffId: string;  
    name: string;  
    hoursWorked: number;  
    hoursAvailable: number;  
    utilization: number;  
    jobsCompleted: number;  
  }\>;  
}

**GET /api/analytics/staff-performance-ranking**

interface PerformanceRankingQuery {  
  period?: 'week' | 'month' | 'quarter' | 'year';  
  metric?: 'rating' | 'jobs\_completed' | 'punctuality' | 'customer\_satisfaction';  
  limit?: number;  
}

interface PerformanceRankingResponse {  
  rankings: Array\<{  
    rank: number;  
    staffId: string;  
    name: string;  
    score: number;  
    change: number;             // Change from previous period  
    badge?: string;             // "Top Performer", "Most Improved"  
  }\>;  
}

### **7.2 Webhook Endpoints**

**POST /api/webhooks/n8n**

// For N8N to send data back to system  
interface N8NWebhookPayload {  
  eventType: 'booking.confirmed' | 'booking.reminder' | 'booking.feedback' |   
             'staff.assigned' | 'staff.leave\_approved';  // (NEW)  
  bookingId?: string;  
  staffId?: string;             // (NEW)  
  data: Record\<string, any\>;  
  timestamp: string;  
}

// Response  
interface WebhookResponse {  
  received: boolean;  
  processedAt: string;  
}

### **7.3 Error Response Format**

interface ErrorResponse {  
  error: {  
    code: string;              // "VALIDATION\_ERROR", "STAFF\_UNAVAILABLE", "BOOKING\_CONFLICT"  
    message: string;           // Human-readable message  
    details?: Array\<{  
      field: string;  
      message: string;  
    }\>;  
    timestamp: string;  
    requestId: string;         // For support/debugging  
  };  
}  
