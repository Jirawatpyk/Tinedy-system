# Story 1.16: Booking Quick Actions

## Status
Approved

## Story
**As an** admin user,
**I want** quick action buttons on each booking row,
**so that** I can perform common tasks without opening details.

## Acceptance Criteria
1. Quick action menu (kebab/three-dot icon) on each row
2. Actions include: View Details, Edit, Assign Staff, Cancel, Duplicate
3. Actions contextual based on booking status
4. Disabled actions shown greyed out with tooltip explanation
5. Confirmation required for destructive actions
6. Keyboard shortcut support
7. Actions complete without leaving list view

## Tasks / Subtasks
- [ ] Task 1: Create quick actions dropdown menu (AC: 1, 2)
  - [ ] Create QuickActionsMenu component
  - [ ] Use shadcn/ui DropdownMenu
  - [ ] Add kebab icon (MoreVertical) button
  - [ ] Position in last column of table
  - [ ] List all available actions
- [ ] Task 2: Implement action items (AC: 2)
  - [ ] Add "View Details" action
  - [ ] Add "Edit" action
  - [ ] Add "Assign Staff" action (opens staff selector)
  - [ ] Add "Cancel Booking" action
  - [ ] Add "Duplicate" action
  - [ ] Add appropriate icons for each action
- [ ] Task 3: Implement contextual actions (AC: 3, 4)
  - [ ] Show/hide actions based on booking status
  - [ ] Disable "Edit" for completed bookings
  - [ ] Disable "Cancel" for completed/cancelled bookings
  - [ ] Disable "Assign Staff" if already assigned (change to "Reassign")
  - [ ] Add tooltips explaining why disabled
- [ ] Task 4: Add tooltips for disabled actions (AC: 4)
  - [ ] Create TooltipWrapper component
  - [ ] Show reason when hovering disabled action
  - [ ] Use shadcn/ui Tooltip
  - [ ] Examples: "ไม่สามารถแก้ไขการจองที่เสร็จสิ้นแล้ว"
- [ ] Task 5: Implement confirmation dialogs (AC: 5)
  - [ ] Show confirmation for "Cancel" action
  - [ ] Reuse CancelBookingDialog from Story 1.8
  - [ ] Quick confirm for non-destructive actions
  - [ ] Allow clicking outside to dismiss
- [ ] Task 6: Implement inline actions (AC: 7)
  - [ ] Handle "View Details" (open sheet/modal)
  - [ ] Handle "Edit" (navigate or open modal)
  - [ ] Handle "Assign Staff" (open staff selector)
  - [ ] Handle "Cancel" (show cancel dialog)
  - [ ] Handle "Duplicate" (navigate to create form)
  - [ ] Update list view after actions complete
- [ ] Task 7: Add keyboard shortcuts (AC: 6)
  - [ ] Define shortcuts for common actions with modifier keys
  - [ ] Ctrl+E (Cmd+E on Mac): Edit selected booking
  - [ ] Ctrl+D (Cmd+D on Mac): Duplicate selected booking
  - [ ] Delete key: Cancel selected booking (with confirmation)
  - [ ] Enter: View details (no modifier needed)
  - [ ] Arrow Up/Down: Navigate rows
  - [ ] Implement keyboard listener with modifier key detection
  - [ ] Show shortcuts in dropdown menu (platform-aware)
- [ ] Task 8: Implement row selection for keyboard shortcuts
  - [ ] Add row selection state
  - [ ] Highlight selected row
  - [ ] Use arrow keys to navigate
  - [ ] Enter to open details
- [ ] Task 9: Add loading states
  - [ ] Show spinner during action execution
  - [ ] Disable menu during action
  - [ ] Optimistic UI updates
  - [ ] Revert on error
- [ ] Task 10: Test quick actions
  - [ ] Test all actions from menu
  - [ ] Test contextual action visibility
  - [ ] Test disabled state tooltips
  - [ ] Test confirmations
  - [ ] Test keyboard shortcuts
  - [ ] Test inline updates
  - [ ] Test with different booking statuses

## Dev Notes

### Project Structure

**Relevant Files:**
```
tinedy-app/
├── app/
│   ├── api/bookings/
│   │   ├── route.ts                    (existing - GET/POST)
│   │   └── [id]/
│   │       ├── route.ts                (existing - GET/PATCH)
│   │       └── assign/
│   │           └── route.ts            (NEW - PATCH assign staff)
│   ├── bookings/
│   │   └── page.tsx                    (existing - to be modified)
├── components/bookings/
│   ├── BookingsTable.tsx               (existing - to be modified)
│   ├── QuickActionsMenu.tsx            (NEW)
│   ├── StaffSelectorDialog.tsx         (NEW)
│   └── CancelBookingDialog.tsx         (existing - from Story 1.8)
├── components/staff/
│   └── StaffCard.tsx                   (from Epic 2 - reuse if available)
├── hooks/
│   ├── useAssignStaff.ts               (NEW)
│   └── useStaff.ts                     (NEW - or from Epic 2)
├── types/
│   └── booking.ts                      (existing)
```

### API Endpoint: Assign Staff to Booking

**NEW Endpoint Required:**

```typescript
// app/api/bookings/[id]/assign/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { adminDb } from '@/lib/firebase/admin';
import { FieldValue } from 'firebase-admin/firestore';

export async function PATCH(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const { staffId } = await request.json();
    const bookingId = params.id;

    // Get staff info
    const staffDoc = await adminDb.collection('staff').doc(staffId).get();
    if (!staffDoc.exists) {
      return NextResponse.json({ error: 'Staff not found' }, { status: 404 });
    }

    const staffData = staffDoc.data();

    // Update booking with staff assignment
    await adminDb.collection('bookings').doc(bookingId).update({
      assignedTo: {
        staffId,
        staffName: `${staffData?.firstName} ${staffData?.lastName}`,
        assignedAt: FieldValue.serverTimestamp(),
      },
      updatedAt: FieldValue.serverTimestamp(),
      updatedBy: 'current-user-id', // TODO: Get from auth context
    });

    // Get updated booking
    const updatedBooking = await adminDb.collection('bookings').doc(bookingId).get();

    return NextResponse.json({
      booking: { id: updatedBooking.id, ...updatedBooking.data() }
    });
  } catch (error) {
    console.error('Error assigning staff:', error);
    return NextResponse.json(
      { error: 'Failed to assign staff' },
      { status: 500 }
    );
  }
}
```

**API Specification:**
- **Method:** PATCH
- **Path:** `/api/bookings/{id}/assign`
- **Request Body:** `{ staffId: string }`
- **Response:** `{ booking: Booking }`
- **Status Codes:** 200 (Success), 404 (Staff not found), 500 (Server error)

### Custom Hooks

**useStaff Hook:**
```typescript
// hooks/useStaff.ts
import { useQuery } from '@tanstack/react-query';

interface UseStaffOptions {
  available?: boolean;
  date?: string;
}

export function useStaff(options: UseStaffOptions = {}) {
  return useQuery({
    queryKey: ['staff', options],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (options.available) params.set('available', 'true');
      if (options.date) params.set('date', options.date);

      const response = await fetch(`/api/staff?${params.toString()}`);
      if (!response.ok) throw new Error('Failed to fetch staff');

      const data = await response.json();
      return data.staff;
    },
    enabled: !!options.date, // Only fetch if date is provided
  });
}
```

**Note:** This hook depends on `/api/staff` endpoint from Epic 2. If not available yet, use mock data or simplified version.

### Component Implementation

**Quick Actions Menu (Platform-Aware):**
```typescript
// components/bookings/QuickActionsMenu.tsx
'use client';
import { useState, useMemo } from 'react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
  DropdownMenuShortcut,
} from '@/components/ui/dropdown-menu';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Button } from '@/components/ui/button';
import {
  MoreVertical,
  Eye,
  Edit,
  UserPlus,
  XCircle,
  Copy,
} from 'lucide-react';
import { CancelBookingDialog } from './CancelBookingDialog';
import { StaffSelectorDialog } from './StaffSelectorDialog';
import { getModifierKey } from '@/utils/keyboardShortcuts';
import type { Booking } from '@/types/booking';

interface QuickActionsMenuProps {
  booking: Booking;
  onViewDetails: () => void;
  onEdit: () => void;
  onAssignStaff: (staffId: string) => void;
  onCancel: () => void;
  onDuplicate: () => void;
}

export function QuickActionsMenu({
  booking,
  onViewDetails,
  onEdit,
  onAssignStaff,
  onCancel,
  onDuplicate,
}: QuickActionsMenuProps) {
  const [showCancelDialog, setShowCancelDialog] = useState(false);
  const [showStaffSelector, setShowStaffSelector] = useState(false);

  // Platform-aware modifier key (⌘ on Mac, Ctrl on Windows/Linux)
  const modifierKey = useMemo(() => getModifierKey(), []);

  const isCompleted = booking.status === 'completed';
  const isCancelled = booking.status === 'cancelled';
  const isTerminal = isCompleted || isCancelled;
  const hasStaff = Boolean(booking.assignedTo);

  // Define action availability
  const actions = {
    viewDetails: { enabled: true, tooltip: '' },
    edit: {
      enabled: !isTerminal,
      tooltip: isTerminal ? 'ไม่สามารถแก้ไขการจองที่เสร็จสิ้นหรือยกเลิกแล้ว' : '',
    },
    assignStaff: {
      enabled: !isTerminal,
      tooltip: isTerminal ? 'ไม่สามารถมอบหมายพนักงานให้การจองที่เสร็จสิ้นแล้ว' : '',
    },
    cancel: {
      enabled: !isTerminal,
      tooltip: isTerminal ? 'ไม่สามารถยกเลิกการจองที่เสร็จสิ้นหรือยกเลิกแล้ว' : '',
    },
    duplicate: { enabled: true, tooltip: '' },
  };

  const ActionItem = ({
    action,
    icon: Icon,
    label,
    onClick,
    shortcut,
    variant = 'default',
  }: any) => {
    const item = (
      <DropdownMenuItem
        onClick={action.enabled ? onClick : undefined}
        disabled={!action.enabled}
        className={variant === 'destructive' ? 'text-red-600 focus:text-red-600' : ''}
      >
        <Icon className="mr-2 h-4 w-4" />
        {label}
        {shortcut && <DropdownMenuShortcut>{shortcut}</DropdownMenuShortcut>}
      </DropdownMenuItem>
    );

    if (!action.enabled && action.tooltip) {
      return (
        <TooltipProvider>
          <Tooltip>
            <TooltipTrigger asChild>{item}</TooltipTrigger>
            <TooltipContent>
              <p>{action.tooltip}</p>
            </TooltipContent>
          </Tooltip>
        </TooltipProvider>
      );
    }

    return item;
  };

  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="ghost" size="sm" className="h-8 w-8 p-0">
            <MoreVertical className="h-4 w-4" />
            <span className="sr-only">เปิดเมนู</span>
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end" className="w-56">
          <ActionItem
            action={actions.viewDetails}
            icon={Eye}
            label="ดูรายละเอียด"
            onClick={onViewDetails}
            shortcut="⏎"
          />
          <ActionItem
            action={actions.edit}
            icon={Edit}
            label="แก้ไข"
            onClick={onEdit}
            shortcut={`${modifierKey}E`}
          />
          <ActionItem
            action={actions.assignStaff}
            icon={UserPlus}
            label={hasStaff ? 'เปลี่ยนพนักงาน' : 'มอบหมายพนักงาน'}
            onClick={() => setShowStaffSelector(true)}
          />
          <ActionItem
            action={actions.duplicate}
            icon={Copy}
            label="ทำซ้ำ"
            onClick={onDuplicate}
            shortcut={`${modifierKey}D`}
          />

          <DropdownMenuSeparator />

          <ActionItem
            action={actions.cancel}
            icon={XCircle}
            label="ยกเลิกการจอง"
            onClick={() => setShowCancelDialog(true)}
            shortcut="⌫"
            variant="destructive"
          />
        </DropdownMenuContent>
      </DropdownMenu>

      <CancelBookingDialog
        booking={booking}
        isOpen={showCancelDialog}
        onClose={() => setShowCancelDialog(false)}
        onSuccess={onCancel}
      />

      <StaffSelectorDialog
        booking={booking}
        isOpen={showStaffSelector}
        onClose={() => setShowStaffSelector(false)}
        onSelect={onAssignStaff}
      />
    </>
  );
}
```

**Integration with Bookings Table:**
```typescript
// components/bookings/BookingsTable.tsx
import { QuickActionsMenu } from './QuickActionsMenu';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

export function BookingsTable({ bookings }: BookingsTableProps) {
  const router = useRouter();
  const [selectedBookingId, setSelectedBookingId] = useState<string | null>(null);

  const handleViewDetails = (booking: Booking) => {
    setSelectedBookingId(booking.id);
    // Open detail sheet/modal
  };

  const handleEdit = (booking: Booking) => {
    router.push(`/bookings/${booking.id}/edit`);
  };

  const handleAssignStaff = async (bookingId: string, staffId: string) => {
    // Call API to assign staff
    await assignStaffToBooking(bookingId, staffId);
    // Refresh data
  };

  const handleCancel = () => {
    // Callback after cancel success
    // Data will be refreshed via React Query invalidation
  };

  const handleDuplicate = (booking: Booking) => {
    router.push(`/bookings/new?duplicate=${booking.id}`);
  };

  return (
    <Table>
      <TableBody>
        {bookings.map((booking) => (
          <TableRow
            key={booking.id}
            className={cn(
              'cursor-pointer hover:bg-slate-50',
              selectedBookingId === booking.id && 'bg-blue-50'
            )}
            onClick={() => setSelectedBookingId(booking.id)}
          >
            <TableCell>{booking.id}</TableCell>
            <TableCell>{booking.customer.name}</TableCell>
            <TableCell>
              <StatusBadge status={booking.status} />
            </TableCell>
            {/* Other cells */}
            <TableCell onClick={(e) => e.stopPropagation()}>
              <QuickActionsMenu
                booking={booking}
                onViewDetails={() => handleViewDetails(booking)}
                onEdit={() => handleEdit(booking)}
                onAssignStaff={(staffId) => handleAssignStaff(booking.id, staffId)}
                onCancel={handleCancel}
                onDuplicate={() => handleDuplicate(booking)}
              />
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
}
```

### Keyboard Shortcuts Implementation

**Improved with Modifier Keys (UX Best Practice):**

```typescript
// app/bookings/page.tsx
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (!selectedBookingId) return;

    // Don't interfere with inputs, textareas, or contenteditable
    const target = e.target as HTMLElement;
    if (
      target instanceof HTMLInputElement ||
      target instanceof HTMLTextAreaElement ||
      target.isContentEditable
    ) return;

    const booking = bookings.find(b => b.id === selectedBookingId);
    if (!booking) return;

    // Detect modifier key (Ctrl on Windows/Linux, Cmd on Mac)
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    const modifierKey = isMac ? e.metaKey : e.ctrlKey;

    // Enter key: View details (no modifier needed)
    if (e.key === 'Enter') {
      e.preventDefault();
      handleViewDetails(booking);
      return;
    }

    // Delete key: Cancel booking (with confirmation)
    if (e.key === 'Delete') {
      e.preventDefault();
      if (!isTerminalStatus(booking.status)) {
        setShowCancelDialog(true);
      }
      return;
    }

    // Modifier + E: Edit
    if (modifierKey && e.key.toLowerCase() === 'e') {
      e.preventDefault();
      if (!isTerminalStatus(booking.status)) {
        handleEdit(booking);
      }
      return;
    }

    // Modifier + D: Duplicate
    if (modifierKey && e.key.toLowerCase() === 'd') {
      e.preventDefault();
      handleDuplicate(booking);
      return;
    }

    // Arrow keys: Navigate rows (no modifier needed)
    const currentIndex = bookings.findIndex(b => b.id === selectedBookingId);

    if (e.key === 'ArrowDown' && currentIndex < bookings.length - 1) {
      e.preventDefault();
      setSelectedBookingId(bookings[currentIndex + 1].id);
    } else if (e.key === 'ArrowUp' && currentIndex > 0) {
      e.preventDefault();
      setSelectedBookingId(bookings[currentIndex - 1].id);
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [selectedBookingId, bookings]);
```

**Platform-Aware Shortcut Display:**
```typescript
// utils/keyboardShortcuts.ts
export function getModifierKey(): string {
  const isMac = typeof navigator !== 'undefined' &&
    navigator.platform.toUpperCase().indexOf('MAC') >= 0;
  return isMac ? '⌘' : 'Ctrl';
}

export const KEYBOARD_SHORTCUTS = {
  viewDetails: { key: 'Enter', display: '⏎' },
  edit: { key: 'E', display: `${getModifierKey()}+E` },
  duplicate: { key: 'D', display: `${getModifierKey()}+D` },
  cancel: { key: 'Delete', display: '⌫' },
  navigateDown: { key: 'ArrowDown', display: '↓' },
  navigateUp: { key: 'ArrowUp', display: '↑' },
};
```

### Staff Selector Dialog (Quick Assign)

```typescript
// components/bookings/StaffSelectorDialog.tsx
'use client';
import { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { useStaff } from '@/hooks/useStaff';
import { StaffCard } from '@/components/staff/StaffCard';
import type { Booking } from '@/types/booking';

interface StaffSelectorDialogProps {
  booking: Booking;
  isOpen: boolean;
  onClose: () => void;
  onSelect: (staffId: string) => void;
}

export function StaffSelectorDialog({
  booking,
  isOpen,
  onClose,
  onSelect,
}: StaffSelectorDialogProps) {
  const { data: staff, isLoading } = useStaff({
    available: true,
    date: booking.schedule.date,
  });

  const handleSelect = (staffId: string) => {
    onSelect(staffId);
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>เลือกพนักงาน</DialogTitle>
        </DialogHeader>

        <div className="grid grid-cols-2 gap-4 mt-4">
          {isLoading ? (
            <p>กำลังโหลด...</p>
          ) : staff?.length === 0 ? (
            <p className="col-span-2 text-center text-slate-600">
              ไม่มีพนักงานว่างในช่วงเวลานี้
            </p>
          ) : (
            staff?.map((member) => (
              <div
                key={member.id}
                className="cursor-pointer"
                onClick={() => handleSelect(member.id)}
              >
                <StaffCard staff={member} showAvailability />
              </div>
            ))
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### Optimistic Updates

```typescript
// hooks/useAssignStaff.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';

export function useAssignStaff() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ bookingId, staffId }: { bookingId: string; staffId: string }) => {
      const response = await fetch(`/api/bookings/${bookingId}/assign`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ staffId }),
      });

      if (!response.ok) throw new Error('Failed to assign staff');
      return response.json();
    },
    onMutate: async ({ bookingId, staffId }) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['bookings'] });

      // Snapshot previous value
      const previousBookings = queryClient.getQueryData(['bookings']);

      // Optimistically update
      queryClient.setQueryData(['bookings'], (old: any) => {
        return {
          ...old,
          bookings: old.bookings.map((b: Booking) =>
            b.id === bookingId
              ? { ...b, assignedTo: { staffId, staffName: 'กำลังโหลด...' } }
              : b
          ),
        };
      });

      return { previousBookings };
    },
    onError: (err, variables, context) => {
      // Rollback on error
      if (context?.previousBookings) {
        queryClient.setQueryData(['bookings'], context.previousBookings);
      }
    },
    onSettled: () => {
      // Refetch to get actual data
      queryClient.invalidateQueries({ queryKey: ['bookings'] });
    },
  });
}
```

### Performance & Mobile Considerations

**Performance Optimization:**
- Use React Query for optimistic updates to reduce perceived latency
- Debounce rapid clicks on action buttons
- Cache staff list for 5 minutes to reduce API calls
- Lazy load StaffSelectorDialog only when needed

**Mobile Responsiveness:**
```typescript
// For mobile devices, consider using Sheet instead of Dropdown
import { useMediaQuery } from '@/hooks/useMediaQuery';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';

export function QuickActionsMenu({ booking, ... }: QuickActionsMenuProps) {
  const isMobile = useMediaQuery('(max-width: 768px)');

  if (isMobile) {
    return (
      <Sheet>
        <SheetTrigger asChild>
          <Button variant="ghost" size="sm">
            <MoreVertical className="h-4 w-4" />
          </Button>
        </SheetTrigger>
        <SheetContent side="bottom" className="h-auto">
          {/* Action buttons in sheet format for better mobile UX */}
        </SheetContent>
      </Sheet>
    );
  }

  // Desktop: Use DropdownMenu as shown above
  return <DropdownMenu>...</DropdownMenu>;
}
```

### Security & RBAC
[Source: docs/architecture/Tinedy - Architecture - Core Booking.md#6.1 RBAC]

**Access Control:**
- Admin/Operator: Full access to all quick actions
- Staff: Limited access (view only their assigned bookings)
- Viewer: Read-only, no actions enabled

**Implementation:**
```typescript
// components/bookings/QuickActionsMenu.tsx
import { useAuth } from '@/lib/auth/AuthContext';

export function QuickActionsMenu({ booking, ... }: QuickActionsMenuProps) {
  const { user } = useAuth();
  const userRole = user?.role;

  // Filter actions based on role
  const canEdit = ['admin', 'operator'].includes(userRole);
  const canAssignStaff = ['admin', 'operator'].includes(userRole);
  const canCancel = ['admin', 'operator'].includes(userRole);

  // Update actions availability
  const actions = {
    edit: {
      enabled: canEdit && !isTerminal,
      tooltip: !canEdit ? 'คุณไม่มีสิทธิ์แก้ไข' : (isTerminal ? 'ไม่สามารถแก้ไขการจองที่เสร็จสิ้นแล้ว' : ''),
    },
    // ... other actions
  };
}
```

### Error Handling & User Feedback

**Toast Notifications (using Sonner):**
```typescript
// components/bookings/BookingsTable.tsx
import { toast } from 'sonner';

const handleAssignStaff = async (bookingId: string, staffId: string) => {
  const toastId = toast.loading('กำลังมอบหมายพนักงาน...');

  try {
    await assignStaffMutation.mutateAsync({ bookingId, staffId });
    toast.success('มอบหมายพนักงานสำเร็จ', { id: toastId });
  } catch (error) {
    toast.error('ไม่สามารถมอบหมายพนักงานได้', {
      id: toastId,
      description: error instanceof Error ? error.message : 'กรุณาลองใหม่อีกครั้ง'
    });
  }
};

const handleEdit = (booking: Booking) => {
  if (isTerminalStatus(booking.status)) {
    toast.error('ไม่สามารถแก้ไขได้', {
      description: 'การจองนี้เสร็จสิ้นหรือถูกยกเลิกแล้ว'
    });
    return;
  }
  router.push(`/bookings/${booking.id}/edit`);
};
```

**Error Boundaries for Quick Actions:**
```typescript
// components/bookings/QuickActionsErrorBoundary.tsx
'use client';
import { Component, ReactNode } from 'react';
import { toast } from 'sonner';

export class QuickActionsErrorBoundary extends Component<
  { children: ReactNode },
  { hasError: boolean }
> {
  constructor(props: { children: ReactNode }) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError() {
    return { hasError: true };
  }

  componentDidCatch(error: Error) {
    console.error('Quick Actions Error:', error);
    toast.error('เกิดข้อผิดพลาด', {
      description: 'กรุณารีเฟรชหน้าและลองใหม่อีกครั้ง'
    });
  }

  render() {
    if (this.state.hasError) {
      return null; // Fail silently, show toast instead
    }
    return this.props.children;
  }
}
```

### UX & Accessibility Specifications

**Interaction Patterns:**

1. **Menu Trigger Button:**
   ```typescript
   <Button
     variant="ghost"
     size="sm"
     className="h-8 w-8 p-0"
     aria-label={`การดำเนินการสำหรับการจอง ${booking.id}`}
     aria-haspopup="menu"
     aria-expanded={isOpen}
   >
     <MoreVertical className="h-4 w-4" />
     <span className="sr-only">เปิดเมนู</span>
   </Button>
   ```

2. **Focus Management:**
   - When menu opens, focus moves to first menu item
   - When menu closes, focus returns to trigger button
   - Escape key closes menu and returns focus
   - Tab key moves focus outside menu and closes it

3. **Visual States:**
   - **Default**: Gray ghost button with vertical dots icon
   - **Hover**: Light gray background (`bg-slate-100`)
   - **Active/Open**: Subtle shadow or background change
   - **Disabled items**: Gray text (`text-slate-400`), no hover effect
   - **Destructive items**: Red text (`text-red-600`) on hover

**Accessibility (WCAG 2.1 AA Compliance):**

```typescript
// Enhanced QuickActionsMenu with full accessibility
<DropdownMenuContent
  align="end"
  className="w-56"
  role="menu"
  aria-label="การดำเนินการกับการจอง"
>
  <DropdownMenuItem
    onClick={action.enabled ? onClick : undefined}
    disabled={!action.enabled}
    role="menuitem"
    aria-disabled={!action.enabled}
    onFocus={(e) => {
      // Announce disabled state to screen readers
      if (!action.enabled && action.tooltip) {
        e.currentTarget.setAttribute('aria-describedby', 'tooltip-' + label);
      }
    }}
  >
    {/* Menu item content */}
  </DropdownMenuItem>
</DropdownMenuContent>
```

**Keyboard Navigation:**
- ✅ Tab: Focus trigger button
- ✅ Enter/Space: Open menu
- ✅ Arrow Down: Focus next item
- ✅ Arrow Up: Focus previous item
- ✅ Escape: Close menu
- ✅ Ctrl/Cmd + E: Edit (global shortcut when row selected)
- ✅ Ctrl/Cmd + D: Duplicate (global shortcut when row selected)
- ✅ Delete: Cancel (global shortcut when row selected)

**Screen Reader Announcements:**
```typescript
// Example ARIA live region for actions
<div aria-live="polite" aria-atomic="true" className="sr-only">
  {actionStatus && `${actionStatus.type}: ${actionStatus.message}`}
</div>

// Usage:
setActionStatus({ type: 'สำเร็จ', message: 'มอบหมายพนักงานเรียบร้อยแล้ว' });
```

**Touch Target Sizes (Mobile):**
- Minimum 44x44px for all interactive elements
- Increased spacing between menu items on mobile (12px → 16px)
- Larger sheet trigger button on mobile (48x48px)

**Mobile UX Pattern (Sheet Component):**
```typescript
// Mobile: Bottom sheet with larger touch targets
<SheetContent side="bottom" className="h-auto rounded-t-lg">
  <SheetHeader>
    <SheetTitle>การดำเนินการ</SheetTitle>
    <SheetDescription>
      การจอง #{booking.id} - {booking.customer.name}
    </SheetDescription>
  </SheetHeader>

  <div className="grid gap-3 py-4">
    {/* Action buttons as large cards */}
    <Button
      variant="outline"
      className="h-14 justify-start gap-3"
      onClick={onViewDetails}
    >
      <Eye className="h-5 w-5" />
      <span className="text-base">ดูรายละเอียด</span>
    </Button>

    {/* Destructive action separated */}
    <Separator className="my-2" />

    <Button
      variant="destructive"
      className="h-14 justify-start gap-3"
      disabled={!actions.cancel.enabled}
      onClick={() => setShowCancelDialog(true)}
    >
      <XCircle className="h-5 w-5" />
      <span className="text-base">ยกเลิกการจอง</span>
    </Button>
  </div>
</SheetContent>
```

### Design System
[Source: CLAUDE.md - Design Tokens]

**Desktop Dropdown Menu:**
- Component: shadcn/ui DropdownMenu
- Width: 224px (w-56)
- Padding: 4px (p-1)
- Item height: 32px
- Item padding: 8px 12px
- Border radius: 8px (rounded-lg)
- Shadow: subtle drop shadow
- Animation: fade-in + slide-down (200ms)

**Mobile Bottom Sheet:**
- Component: shadcn/ui Sheet
- Side: bottom
- Max height: 80vh
- Border radius: 16px (rounded-t-lg) top only
- Backdrop: Semi-transparent overlay
- Animation: slide-up (300ms)
- Drag-to-close: Enabled (swipe down)

**Color Tokens:**
- **Default text**: Slate 900 (#0F172A)
- **Disabled text**: Slate 400 (#94A3B8)
- **Destructive**: Red 600 (#DC2626)
- **Hover background**: Slate 100 (#F1F5F9)
- **Focus ring**: Blue 500 (#3B82F6) with 2px offset
- **Separator**: Slate 200 (#E2E8F0)

**Typography:**
- **Menu items**: 14px (text-sm), Regular weight
- **Shortcuts**: 12px (text-xs), Slate 500
- **Sheet title**: 18px (text-lg), Semibold
- **Sheet description**: 14px (text-sm), Slate 600

**Icons:**
- Source: lucide-react
- Size: 16px (h-4 w-4) for dropdown, 20px (h-5 w-5) for sheet
- Stroke width: 2px
- Color: Inherits from text

### Testing

**Testing Standards:**
[Source: CLAUDE.md - Technology Stack]

**Test Framework:** Jest + React Testing Library + MSW (Mock Service Worker)

**Test File Location:**
```
tinedy-app/
├── __tests__/
│   ├── components/bookings/
│   │   ├── QuickActionsMenu.test.tsx
│   │   └── StaffSelectorDialog.test.tsx
│   ├── hooks/
│   │   └── useAssignStaff.test.tsx
│   └── integration/
│       └── booking-quick-actions.test.tsx
```

**Required Test Coverage:**
- Component rendering tests (all states)
- User interaction tests (clicks, keyboard)
- API integration tests (mocked with MSW)
- Error handling tests
- Accessibility tests (ARIA, keyboard navigation)

**Testing Commands:**
```bash
npm run test                 # Run all tests
npm run test:watch          # Watch mode
npm run test:coverage       # Generate coverage report
```

**Testing Standards:**
- Test all actions in menu
- Test contextual availability
- Test disabled state tooltips
- Test keyboard shortcuts
- Test confirmations
- Test inline updates

**Functional Test Scenarios:**
1. Open quick actions menu
2. View details from menu
3. Edit booking from menu (not completed)
4. Attempt to edit completed booking (disabled)
5. Assign staff from menu
6. Reassign staff if already assigned
7. Cancel booking with confirmation
8. Duplicate booking from menu
9. Test keyboard shortcut: Ctrl/Cmd+E for edit
10. Test keyboard shortcut: Ctrl/Cmd+D for duplicate
11. Test keyboard shortcut: Enter for view details
12. Test keyboard shortcut: Delete for cancel
13. Test arrow keys for row navigation
14. Test tooltips on disabled actions
15. Test optimistic updates for assign staff
16. Verify actions update list view immediately

**UX & Accessibility Test Scenarios:**

**A. Keyboard-Only Navigation:**
1. Tab to quick actions button
2. Press Enter to open menu
3. Arrow down/up to navigate items
4. Press Enter to activate item
5. Press Escape to close menu
6. Verify focus returns to trigger button

**B. Screen Reader Testing (VoiceOver/NVDA):**
1. Verify trigger button announces: "การดำเนินการสำหรับการจอง [ID], ปุ่ม"
2. When menu opens, verify first item receives focus
3. Verify disabled items announce: "ไม่สามารถใช้งาน, [tooltip text]"
4. Verify shortcuts are announced correctly
5. Verify toast notifications are announced via aria-live

**C. Mobile Touch Experience:**
1. Tap trigger button (verify 44x44px touch target)
2. Verify sheet slides up from bottom
3. Tap action button (verify 56px minimum height)
4. Swipe down to close sheet
5. Verify sheet backdrop dismisses on tap
6. Test with one-handed thumb reach (bottom 30% of screen)

**D. Visual & Motion:**
1. Verify menu fade-in animation (200ms)
2. Verify sheet slide-up animation (300ms)
3. Verify disabled items have 0.5 opacity
4. Verify destructive items turn red on hover
5. Verify loading spinner appears during async actions
6. Verify optimistic UI updates before API response

**E. Error & Edge Cases:**
1. Open menu while offline → Show appropriate error
2. Rapidly click multiple actions → Debounce prevents double-execution
3. Action fails → Toast error + rollback optimistic update
4. User has "viewer" role → All actions disabled with tooltip
5. Long staff name in selector → Truncate with ellipsis
6. Slow network → Show loading state for >500ms

**F. Responsive Breakpoints:**
1. Desktop (≥1024px): DropdownMenu, 224px width
2. Tablet (768-1023px): DropdownMenu, full keyboard support
3. Mobile (<768px): Bottom Sheet, touch-optimized
4. Verify transition at breakpoint (resize window)

**G. Color Contrast & Readability:**
1. Verify all text meets 4.5:1 contrast ratio
2. Verify disabled text meets 3:1 minimum
3. Verify focus indicator is visible (2px blue ring)
4. Test in dark mode (if supported)
5. Test with color blindness simulators

### Architecture Notes

**Key Architecture Decisions:**

1. **New API Endpoint Required:** `/api/bookings/{id}/assign`
   - PATCH method to assign/reassign staff to booking
   - Updates `assignedTo` field with staff info and timestamp
   - Returns updated booking object

2. **React Query Integration:** Already installed (`@tanstack/react-query: ^5.90.2`)
   - Use for optimistic updates to improve UX
   - Cache invalidation after mutations
   - Error handling with rollback support

3. **Keyboard Shortcuts UX:**
   - Use modifier keys (Ctrl/Cmd) to prevent conflicts
   - Platform-aware display (⌘ on Mac, Ctrl on Windows)
   - Arrow keys for navigation (no modifier needed)

4. **Mobile Responsiveness:**
   - Use Sheet component for mobile instead of DropdownMenu
   - Better touch target sizes
   - Bottom sheet for better reachability

5. **Dependencies Verified:**
   - ✅ CancelBookingDialog from Story 1.8 (exists)
   - ✅ React Query installed
   - ✅ Sonner for toast notifications
   - ⚠️ useStaff hook needs Epic 2 `/api/staff` endpoint (use mock if not ready)
   - ⚠️ StaffCard component from Epic 2 (create simplified version if not ready)

6. **Performance Considerations:**
   - Optimistic updates reduce perceived latency
   - Staff list caching (5 min TTL)
   - Lazy load heavy dialogs
   - Debounce rapid actions

### UX Design Recommendations

**Visual Hierarchy:**
1. **Primary Actions** (View Details, Edit): Regular weight, prominent position
2. **Secondary Actions** (Assign Staff, Duplicate): Regular weight, middle position
3. **Destructive Actions** (Cancel): Red color, separated with divider, bottom position

**Micro-interactions:**
- Hover: 100ms fade to background color
- Click: Subtle scale down (0.98) for tactile feedback
- Menu open: Fade + slide down 200ms with ease-out
- Toast: Slide in from top-right with bounce effect
- Loading: Spinner with 60fps smooth rotation
- Success: Checkmark icon with scale-in animation

**Loading States Patterns:**
```typescript
// Button loading state
<Button disabled={isLoading}>
  {isLoading ? (
    <>
      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
      กำลังโหลด...
    </>
  ) : (
    <>
      <Icon className="mr-2 h-4 w-4" />
      Label
    </>
  )}
</Button>

// Optimistic update skeleton
<div className="animate-pulse">
  <div className="h-4 bg-slate-200 rounded w-3/4"></div>
</div>
```

**Empty & Error States:**
```typescript
// No actions available (viewer role)
<DropdownMenuContent>
  <div className="px-4 py-3 text-center text-sm text-slate-500">
    <AlertCircle className="mx-auto h-8 w-8 mb-2 opacity-30" />
    <p>ไม่มีการดำเนินการที่ใช้ได้</p>
    <p className="text-xs mt-1">คุณไม่มีสิทธิ์ทำรายการนี้</p>
  </div>
</DropdownMenuContent>
```

**Progressive Disclosure:**
- Show only essential actions initially (View, Edit, Cancel)
- "More actions" submenu for less common actions (if needed in future)
- Tooltips reveal on hover (300ms delay)
- Keyboard shortcuts visible only when menu is open

**Notification Strategy:**
- **Success**: Brief toast (2s), green checkmark icon
- **Error**: Persistent toast (5s), red X icon, retry button
- **Loading**: Spinner toast, auto-updates to success/error
- **Info**: Blue info icon, 3s duration
- Position: Top-right on desktop, top-center on mobile

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | SM (Bob) |
| 2025-10-04 | 1.1 | Architecture review: Added API endpoints, hooks, keyboard shortcuts improvements, testing standards, error handling, RBAC implementation | Architect (Winston) |
| 2025-10-04 | 1.2 | UX Review: Added comprehensive accessibility specs (ARIA, keyboard nav, screen reader), mobile UX patterns (bottom sheet), visual design system, micro-interactions, and extensive UX test scenarios | UX Expert (Sally) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
