# Story 1.15: Export Bookings

## Status
Approved

## Story
**As an** admin user,
**I want** to export bookings to CSV/Excel,
**so that** I can analyze data or share with team.

## Acceptance Criteria
1. Export button prominent in list view
2. Export respects current filters
3. Export includes all visible columns plus IDs
4. File name includes date range: "bookings_2025-10-01_to_2025-10-31.csv"
5. Thai characters exported correctly (UTF-8)
6. Dates formatted consistently
7. Large exports (>500 rows) show progress indicator
8. Download starts automatically
9. Success message shown

## Tasks / Subtasks
- [ ] Task 1: Add export button to toolbar (AC: 1)
  - [ ] Create ExportButton component
  - [ ] Position in header near filters
  - [ ] Use Download icon
  - [ ] Style with outline variant
  - [ ] Show count of records to be exported
- [ ] Task 2: Implement export logic (AC: 2, 3)
  - [ ] Fetch all bookings matching current filters
  - [ ] Convert to CSV format
  - [ ] Include columns: ID, date, time, customer name, phone, email, address, service type, status, staff name, created date
  - [ ] Use UTF-8 BOM for Thai characters
  - [ ] Respect current filters (don't export all if filtered)
- [ ] Task 3: Generate CSV file (AC: 4, 5, 6)
  - [ ] Create CSV headers in Thai
  - [ ] Format dates as "DD/MM/YYYY"
  - [ ] Format times as "HH:mm น."
  - [ ] Escape commas and quotes in data
  - [ ] Add UTF-8 BOM (\uFEFF) at start
  - [ ] Generate filename with date range
- [ ] Task 4: Implement download trigger (AC: 8)
  - [ ] Create Blob from CSV string
  - [ ] Create download link
  - [ ] Trigger download automatically
  - [ ] Clean up object URL after download
- [ ] Task 5: Add progress indicator for large exports (AC: 7)
  - [ ] Show loading state during export
  - [ ] Display progress for >500 records
  - [ ] Show "กำลังส่งออกข้อมูล X/Y รายการ"
  - [ ] Allow cancellation for very large exports
- [ ] Task 6: Add success feedback (AC: 9)
  - [ ] Show success toast
  - [ ] Display "ส่งออก X รายการเรียบร้อยแล้ว"
  - [ ] Mention filename in toast
- [ ] Task 7: Create export API endpoint (optional)
  - [ ] POST /api/bookings/export
  - [ ] Accept filter parameters
  - [ ] Generate CSV server-side
  - [ ] Stream response for large files
  - [ ] Return as downloadable file
- [ ] Task 8: Implement error handling
  - [ ] Handle fetch errors
  - [ ] Handle file generation errors
  - [ ] Handle browser download blocking
  - [ ] Show error toast
  - [ ] Log errors
- [ ] Task 9: Test export functionality
  - [ ] Test export with various filters
  - [ ] Test Thai characters in CSV
  - [ ] Test date formatting
  - [ ] Test large exports (>500 records)
  - [ ] Test filename generation
  - [ ] Test in different browsers
  - [ ] Verify CSV opens correctly in Excel

## Dev Notes

### Component Implementation

**Export Button:**
```typescript
// components/bookings/ExportButton.tsx
'use client';
import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Download } from 'lucide-react';
import { useToast } from '@/components/ui/use-toast';
import { exportBookingsToCSV } from '@/lib/utils/export-csv';
import type { Booking } from '@/types/booking';

interface ExportButtonProps {
  bookings: Booking[];
  filters: any;
  totalCount: number;
}

export function ExportButton({ bookings, filters, totalCount }: ExportButtonProps) {
  const [isExporting, setIsExporting] = useState(false);
  const { toast } = useToast();

  const handleExport = async () => {
    try {
      setIsExporting(true);

      // For large exports, fetch all data matching filters
      let dataToExport = bookings;

      if (totalCount > bookings.length) {
        // Fetch all filtered bookings (not just current page)
        const response = await fetch(`/api/bookings?${buildFilterQuery(filters)}&limit=10000`);
        const data = await response.json();
        dataToExport = data.bookings;
      }

      // Generate and download CSV
      const filename = generateFilename(filters.dateRange);
      await exportBookingsToCSV(dataToExport, filename);

      toast({
        title: 'ส่งออกข้อมูลสำเร็จ',
        description: `ส่งออก ${dataToExport.length} รายการเรียบร้อยแล้ว`,
      });
    } catch (error) {
      console.error('Export error:', error);
      toast({
        title: 'เกิดข้อผิดพลาด',
        description: 'ไม่สามารถส่งออกข้อมูลได้',
        variant: 'destructive',
      });
    } finally {
      setIsExporting(false);
    }
  };

  return (
    <Button
      variant="outline"
      onClick={handleExport}
      disabled={isExporting || totalCount === 0}
    >
      <Download className="mr-2 h-4 w-4" />
      {isExporting ? `กำลังส่งออก...` : `ส่งออกข้อมูล (${totalCount})`}
    </Button>
  );
}

function generateFilename(dateRange?: { start: string; end: string }): string {
  if (dateRange?.start && dateRange?.end) {
    return `bookings_${dateRange.start}_to_${dateRange.end}.csv`;
  }
  const today = new Date().toISOString().split('T')[0];
  return `bookings_${today}.csv`;
}
```

### CSV Export Utility

```typescript
// lib/utils/export-csv.ts
import { format } from 'date-fns';
import { th } from 'date-fns/locale';
import type { Booking } from '@/types/booking';

const CSV_HEADERS = [
  'รหัสการจอง',
  'วันที่',
  'เวลา',
  'ชื่อลูกค้า',
  'เบอร์โทร',
  'อีเมล',
  'ที่อยู่',
  'ประเภทบริการ',
  'หมวดหมู่',
  'สถานะ',
  'พนักงาน',
  'สร้างเมื่อ',
  'หมายเหตุ',
];

const STATUS_LABELS = {
  pending: 'รอยืนยัน',
  confirmed: 'ยืนยันแล้ว',
  in_progress: 'กำลังดำเนินการ',
  completed: 'เสร็จสิ้น',
  cancelled: 'ยกเลิก',
};

const SERVICE_TYPE_LABELS = {
  cleaning: 'ทำความสะอาด',
  training: 'ฝึกอบรม',
};

const SERVICE_CATEGORY_LABELS = {
  deep: 'ทำความสะอาดแบบ Deep',
  regular: 'ทำความสะอาดแบบทั่วไป',
  individual: 'ฝึกอบรมรายบุคคล',
  corporate: 'ฝึกอบรมองค์กร',
};

export async function exportBookingsToCSV(bookings: Booking[], filename: string) {
  // Start with UTF-8 BOM for Excel compatibility with Thai characters
  const BOM = '\uFEFF';

  // Create CSV content
  const csvRows: string[] = [];

  // Add headers
  csvRows.push(CSV_HEADERS.join(','));

  // Add data rows
  for (const booking of bookings) {
    const row = [
      booking.id,
      formatDate(booking.schedule.date),
      `${booking.schedule.startTime} น.`,
      escapeCSV(booking.customer.name),
      booking.customer.phone,
      escapeCSV(booking.customer.email || ''),
      escapeCSV(booking.customer.address),
      SERVICE_TYPE_LABELS[booking.service.type],
      SERVICE_CATEGORY_LABELS[booking.service.category],
      STATUS_LABELS[booking.status],
      escapeCSV(booking.assignedTo?.staffName || '-'),
      formatDateTime(booking.createdAt),
      escapeCSV(booking.notes || ''),
    ];

    csvRows.push(row.join(','));
  }

  const csvContent = BOM + csvRows.join('\n');

  // Create blob and download
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.style.display = 'none';

  document.body.appendChild(link);
  link.click();

  // Cleanup
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function escapeCSV(value: string): string {
  if (!value) return '';

  // Escape double quotes by doubling them
  const escaped = value.replace(/"/g, '""');

  // Wrap in quotes if contains comma, newline, or quote
  if (escaped.includes(',') || escaped.includes('\n') || escaped.includes('"')) {
    return `"${escaped}"`;
  }

  return escaped;
}

function formatDate(dateString: string): string {
  try {
    return format(new Date(dateString), 'dd/MM/yyyy', { locale: th });
  } catch {
    return dateString;
  }
}

function formatDateTime(timestamp: any): string {
  try {
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return format(date, 'dd/MM/yyyy HH:mm', { locale: th });
  } catch {
    return '-';
  }
}
```

### Progress Indicator for Large Exports

```typescript
// For very large exports, consider chunking
async function exportLargeDataset(bookings: Booking[], filename: string) {
  const CHUNK_SIZE = 100;
  const chunks = [];

  // Split into chunks
  for (let i = 0; i < bookings.length; i += CHUNK_SIZE) {
    chunks.push(bookings.slice(i, i + CHUNK_SIZE));
  }

  // Show progress dialog
  const { dismiss } = toast({
    title: 'กำลังส่งออกข้อมูล',
    description: `0 / ${bookings.length} รายการ`,
    duration: Infinity,
  });

  // Process chunks
  const csvRows = [CSV_HEADERS.join(',')];

  for (let i = 0; i < chunks.length; i++) {
    const chunk = chunks[i];

    // Convert chunk to CSV rows
    for (const booking of chunk) {
      csvRows.push(convertToCSVRow(booking));
    }

    // Update progress
    const processed = (i + 1) * CHUNK_SIZE;
    toast({
      title: 'กำลังส่งออกข้อมูล',
      description: `${Math.min(processed, bookings.length)} / ${bookings.length} รายการ`,
      duration: Infinity,
    });

    // Small delay to prevent blocking UI
    await new Promise(resolve => setTimeout(resolve, 10));
  }

  dismiss();

  // Create and download file
  const csvContent = '\uFEFF' + csvRows.join('\n');
  downloadCSV(csvContent, filename);
}
```

### Server-side Export (Optional)

```typescript
// app/api/bookings/export/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    // Get filters from query params
    const searchParams = request.nextUrl.searchParams;

    // Fetch all bookings matching filters
    const bookings = await fetchAllBookings(searchParams);

    // Generate CSV
    const csv = generateCSV(bookings);

    // Return as downloadable file
    const filename = `bookings_${new Date().toISOString().split('T')[0]}.csv`;

    return new NextResponse(csv, {
      headers: {
        'Content-Type': 'text/csv;charset=utf-8',
        'Content-Disposition': `attachment; filename="${filename}"`,
      },
    });
  } catch (error) {
    return NextResponse.json({ error: 'Export failed' }, { status: 500 });
  }
}
```

### Security & RBAC
[Source: docs/architecture/Tinedy - Architecture - Core Booking.md#6.1 RBAC]

All authenticated users who can view bookings can export them.

### Performance Considerations
- Limit exports to reasonable size (<10,000 records)
- Use server-side export for very large datasets
- Consider background job for massive exports
- Stream CSV generation to avoid memory issues

### Design System
[Source: docs/architecture/8. UI-UX Spec Design System.md]

**Export Button:**
- Variant: outline
- Icon: Download from lucide-react
- Position: Header toolbar

### Testing

**Testing Standards:**
- Test export with filters applied
- Test Thai character encoding
- Test date formatting in Excel
- Test large datasets
- Test empty results
- Test error handling

### Performance Testing
**Metrics to Monitor:**
- API Response Time (p50, p95, p99)
- Frontend Render Time
- Memory Usage
- Bundle Size Impact

**Load Test Scenarios:**
1. Create 10 bookings concurrently
2. View details with 100 bookings in DB
3. Search with 500 bookings
4. Export 1000 bookings

**Performance Targets:**
- P95 API response: < 500ms
- P95 Frontend render: < 500ms
- Memory leak: None after 1000 operations

**Test Scenarios:**
1. Export all bookings (no filters)
2. Export filtered bookings (by status)
3. Export filtered bookings (by date range)
4. Open exported CSV in Excel
5. Verify Thai characters display correctly
6. Verify dates formatted as DD/MM/YYYY
7. Verify commas in addresses escaped correctly
8. Test export with >500 records
9. Test export with 0 records (should disable button)
10. Test filename includes correct date range
11. Test UTF-8 BOM for Excel compatibility
12. Test export in different browsers

## Architectural Guidance

### 1. Critical Architectural Decisions

**Export Strategy: Client-Side CSV Generation**
- Generate CSV files client-side using Blob API and download via temporary anchor element
- Fetch all filtered data before export, then process in browser
- Decision: Client-side generation acceptable for datasets <10K rows. Avoids server load and streaming complexity for MVP

**UTF-8 Encoding with BOM:**
- Prepend UTF-8 BOM (\uFEFF) to CSV content for Excel compatibility with Thai characters
- Use charset=utf-8 in Blob type specification
- Decision: BOM is essential for Thai character display in Excel - accept minor incompatibility with some Unix tools

**Large Dataset Handling:**
- Show progress indicator for exports >500 records
- Implement chunked processing with small delays to prevent UI blocking
- Decision: Set hard limit of 10,000 records per export. For larger datasets, guide users to use date range filters or contact support

### 2. Technical Risks & Mitigations

**Risk: Browser Memory Limitations**
- Issue: Exporting very large datasets (>5000 bookings) may cause browser memory issues or crashes
- Mitigation: Implement hard limit of 10,000 records. Show warning for exports >1000 records. Consider server-side export endpoint with streaming for future if needed. Monitor memory usage in production

**Risk: CSV Injection Attacks**
- Issue: User-entered data containing formulas (=, +, -, @) may execute in Excel when CSV is opened
- Mitigation: Implement CSV escaping that prefixes formula characters with single quote ('). Sanitize all user-generated content. Add security note in documentation about opening CSVs from untrusted sources

**Risk: Excel Compatibility Issues**
- Issue: Different Excel versions and locales may interpret CSV differently (date formats, number separators)
- Mitigation: Use consistent date format (DD/MM/YYYY) and time format. Test with Excel 2016+ on Windows and Mac. Document known limitations. Consider XLSX format for future enhancement

### 3. Dependencies for Future Stories

**Required by Story 1.12 (Filters):**
- Export must fetch data respecting current filter state
- Filter parameters must be passed to export function
- Date range in filters determines export filename

**Provides Foundation For:**
- Scheduled export reports (daily/weekly automated exports)
- Export to other formats (XLSX, PDF) with same data transformation logic
- Email export feature (export then send via email)

**Future Enhancements:**
- Server-side export API (POST /api/bookings/export) for large datasets
- Export templates (customizable column selection)
- Export history tracking (who exported what and when)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.1 | Added architectural guidance: client-side CSV generation, UTF-8 BOM handling, large dataset limits | Architect (Winston) |
| 2025-10-04 | 1.0 | Initial story creation | SM (Bob) |

## Dev Agent Record
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
